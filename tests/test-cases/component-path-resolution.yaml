# yaml-language-server: $schema=schema.json

tests:
  # Basic path resolution tests
  - name: terraform plan with current directory (.)
    enabled: true
    snapshot: true
    description: "Test terraform plan using . to reference current directory"
    workdir: "fixtures/scenarios/complete/components/terraform/top-level-component1"
    command: "atmos"
    env:
      ATMOS_CLI_CONFIG_PATH: "../../.."
      ATMOS_BASE_PATH: "."
    args:
      - "terraform"
      - "plan"
      - "."
      - "--stack"
      - "tenant1-ue2-dev"
      - "--dry-run"
    expect:
      diff: []
      exit_code: 0

  - name: terraform plan with relative path
    enabled: true
    snapshot: true
    description: "Test terraform plan using relative path"
    workdir: "fixtures/scenarios/complete/components/terraform"
    command: "atmos"
    env:
      ATMOS_CLI_CONFIG_PATH: "../.."
      ATMOS_BASE_PATH: "."
    args:
      - "terraform"
      - "plan"
      - "./top-level-component1"
      - "--stack"
      - "tenant1-ue2-dev"
      - "--dry-run"
    expect:
      diff: []
      exit_code: 0

  - name: terraform plan with nested component path
    enabled: true
    snapshot: true
    description: "Test terraform plan with component in subfolder - detects ambiguous path when multiple components reference same folder"
    workdir: "fixtures/scenarios/complete/components/terraform/infra/vpc"
    command: "atmos"
    env:
      ATMOS_CLI_CONFIG_PATH: "../../../.."
    args:
      - "terraform"
      - "plan"
      - "."
      - "--stack"
      - "tenant1-ue2-dev"
      - "--dry-run"
    expect:
      diff: []
      stderr:
        - "ambiguous component path"
        - "Matching components"
      exit_code: 2

  # Error handling tests
  - name: terraform plan with path not in component directory
    enabled: true
    snapshot: true
    description: "Test error when path is outside component directories"
    workdir: "fixtures/scenarios/complete"
    command: "atmos"
    args:
      - "terraform"
      - "plan"
      - "./stacks"
      - "--stack"
      - "tenant1-ue2-dev"
    expect:
      diff: []
      stderr:
        - "Error"
      exit_code: 2

  - name: terraform plan with path but component not in stack
    enabled: true
    snapshot: true
    description: "Test error when stack doesn't exist (fails early during path resolution)"
    workdir: "fixtures/scenarios/complete/components/terraform/top-level-component1"
    command: "atmos"
    env:
      ATMOS_CLI_CONFIG_PATH: "../../.."
    args:
      - "terraform"
      - "plan"
      - "."
      - "--stack"
      - "nonexistent-stack"
    expect:
      diff: []
      stderr:
        - "stack not found"
      exit_code: 2

  - name: terraform plan with path at component base directory
    enabled: true
    snapshot: true
    description: "Test error when path is the component base directory itself"
    workdir: "fixtures/scenarios/complete/components/terraform"
    command: "atmos"
    env:
      ATMOS_CLI_CONFIG_PATH: "../.."
      ATMOS_BASE_PATH: "."
    args:
      - "terraform"
      - "plan"
      - "."
      - "--stack"
      - "tenant1-ue2-dev"
    expect:
      diff: []
      stderr:
        - "failed to resolve component from path"
      exit_code: 2

  # Component type mismatch tests
  - name: helmfile command with terraform component path
    enabled: true
    snapshot: true
    description: "Test error when using terraform component path with helmfile command"
    workdir: "fixtures/scenarios/complete/components/terraform/top-level-component1"
    command: "atmos"
    env:
      ATMOS_CLI_CONFIG_PATH: "../../.."
    args:
      - "helmfile"
      - "diff"
      - "."
      - "--stack"
      - "tenant1-ue2-dev"
    expect:
      diff: []
      stderr:
        - "path component type does not"
        - "match command"
      exit_code: 2

  # Validation that normal component names still work
  - name: terraform plan with component name (backward compatibility)
    enabled: true
    snapshot: true
    description: "Test that traditional component names still work"
    workdir: "fixtures/scenarios/complete"
    command: "atmos"
    args:
      - "terraform"
      - "plan"
      - "top-level-component1"
      - "--stack"
      - "tenant1-ue2-dev"
      - "--dry-run"
    expect:
      diff: []
      exit_code: 0

  - name: terraform plan with slash-separated component name (backward compatibility)
    enabled: true
    snapshot: true
    description: "Test that component names with slashes still work"
    workdir: "fixtures/scenarios/slash-components"
    command: "atmos"
    args:
      - "terraform"
      - "plan"
      - "infra/vpc"
      - "--stack"
      - "dev"
      - "--dry-run"
    expect:
      diff: []
      exit_code: 0

  # Describe component tests
  - name: describe component with current directory (.)
    enabled: true
    snapshot: true
    description: "Test describe component using . to reference current directory"
    workdir: "fixtures/scenarios/complete/components/terraform/top-level-component1"
    command: "atmos"
    env:
      ATMOS_CLI_CONFIG_PATH: "../../.."
    args:
      - "describe"
      - "component"
      - "."
      - "--stack"
      - "tenant1-ue2-dev"
    expect:
      diff: []
      sanitize:
        "provisioned_by_user: [^\\s]+": "provisioned_by_user: user"
      exit_code: 0

  - name: describe component with relative path
    enabled: true
    snapshot: true
    description: "Test describe component using relative path"
    workdir: "fixtures/scenarios/complete/components/terraform"
    command: "atmos"
    env:
      ATMOS_CLI_CONFIG_PATH: "../.."
      ATMOS_BASE_PATH: "."
    args:
      - "describe"
      - "component"
      - "./top-level-component1"
      - "--stack"
      - "tenant1-ue2-dev"
    expect:
      diff: []
      sanitize:
        "provisioned_by_user: [^\\s]+": "provisioned_by_user: user"
      exit_code: 0

  - name: describe component with nested component path
    enabled: true
    snapshot: true
    description: "Test describe component with component in subfolder - detects ambiguous path when multiple components reference same folder"
    workdir: "fixtures/scenarios/complete/components/terraform/infra/vpc"
    command: "atmos"
    env:
      ATMOS_CLI_CONFIG_PATH: "../../../.."
    args:
      - "describe"
      - "component"
      - "."
      - "--stack"
      - "tenant1-ue2-dev"
    expect:
      diff: []
      stderr:
        - "ambiguous component path"
        - "Matching components"
      exit_code: 2

  - name: describe component with path not in component directory
    enabled: true
    snapshot: true
    description: "Test error when path is outside component directories"
    workdir: "fixtures/scenarios/complete"
    env:
      ATMOS_FORCE_TTY: "true"
    command: "atmos"
    args:
      - "describe"
      - "component"
      - "./stacks"
      - "--stack"
      - "tenant1-ue2-dev"
    expect:
      diff: []
      stderr:
        - "Error"
      exit_code: 2

  - name: describe component with component name (backward compatibility)
    enabled: true
    snapshot: true
    description: "Test that traditional component names still work with describe"
    workdir: "fixtures/scenarios/complete"
    command: "atmos"
    args:
      - "describe"
      - "component"
      - "top-level-component1"
      - "--stack"
      - "tenant1-ue2-dev"
    expect:
      diff: []
      exit_code: 0

  # Validate component tests
  - name: validate component with current directory (.)
    enabled: true
    snapshot: true
    description: "Test validate component using . to reference current directory"
    workdir: "fixtures/scenarios/complete/components/terraform/top-level-component1"
    command: "atmos"
    env:
      ATMOS_CLI_CONFIG_PATH: "../../.."
    args:
      - "validate"
      - "component"
      - "."
      - "--stack"
      - "tenant1-ue2-dev"
    expect:
      diff: []
      exit_code: 0

  - name: validate component with relative path
    enabled: true
    snapshot: true
    description: "Test validate component using relative path"
    workdir: "fixtures/scenarios/complete/components/terraform"
    command: "atmos"
    env:
      ATMOS_CLI_CONFIG_PATH: "../.."
      ATMOS_BASE_PATH: "."
    args:
      - "validate"
      - "component"
      - "./top-level-component1"
      - "--stack"
      - "tenant1-ue2-dev"
    expect:
      diff: []
      exit_code: 0

  - name: validate component with component name (backward compatibility)
    enabled: true
    snapshot: true
    description: "Test that traditional component names still work with validate"
    workdir: "fixtures/scenarios/complete"
    command: "atmos"
    args:
      - "validate"
      - "component"
      - "top-level-component1"
      - "--stack"
      - "tenant1-ue2-dev"
    expect:
      diff: []
      exit_code: 0

  # Ambiguous component path tests (multiple instances)
  # Note: These tests verify the non-interactive (CI/CD) behavior.
  # Interactive selection (TTY available) requires manual testing.
  - name: terraform plan with ambiguous component path (non-interactive)
    enabled: false
    snapshot: true
    description: "Test error when component folder matches multiple instances (non-TTY)"
    workdir: "fixtures/scenarios/component-instances/components/terraform/vpc"
    command: "atmos"
    env:
      ATMOS_CLI_CONFIG_PATH: "../../.."
    args:
      - "terraform"
      - "plan"
      - "."
      - "--stack"
      - "dev"
    expect:
      diff: []
      stderr:
        - "ambiguous component path"
        - "multiple components"
      exit_code: 2

  - name: describe component with ambiguous path (non-interactive)
    enabled: false
    snapshot: true
    description: "Test error when component folder matches multiple instances (non-TTY)"
    workdir: "fixtures/scenarios/component-instances/components/terraform/vpc"
    command: "atmos"
    env:
      ATMOS_CLI_CONFIG_PATH: "../../.."
    args:
      - "describe"
      - "component"
      - "."
      - "--stack"
      - "dev"
    expect:
      diff: []
      stderr:
        - "ambiguous component path"
        - "multiple components"
      exit_code: 2

  # Parent directory atmos.yaml discovery tests
  - name: describe component from nested dir discovers atmos.yaml in parent
    enabled: true
    snapshot: true
    description: "Test that atmos finds atmos.yaml in parent directory when running from component dir"
    workdir: "fixtures/scenarios/opentofu-module-source-interpolation/components/terraform/test-component"
    command: "atmos"
    args:
      - "describe"
      - "component"
      - "."
      - "--stack"
      - "test"
    expect:
      diff: []
      sanitize:
        "provisioned_by_user: [^\\s]+": "provisioned_by_user: user"
        "basePathAbsolute: .+": "basePathAbsolute: /absolute/path"
      exit_code: 0

  - name: terraform plan from nested dir discovers atmos.yaml in parent
    enabled: true
    snapshot: true
    description: "Test that terraform plan works when atmos.yaml is in parent directory"
    workdir: "fixtures/scenarios/opentofu-module-source-interpolation/components/terraform/test-component"
    command: "atmos"
    args:
      - "terraform"
      - "plan"
      - "."
      - "--stack"
      - "test"
      - "--dry-run"
    expect:
      diff: []
      exit_code: 0

  - name: validate component from nested dir discovers atmos.yaml in parent
    enabled: true
    snapshot: true
    description: "Test that validate component works when atmos.yaml is in parent directory"
    workdir: "fixtures/scenarios/opentofu-module-source-interpolation/components/terraform/test-component"
    command: "atmos"
    args:
      - "validate"
      - "component"
      - "."
      - "--stack"
      - "test"
    expect:
      diff: []
      exit_code: 0
