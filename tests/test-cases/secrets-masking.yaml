# yaml-language-server: $schema=schema.json
tests:
  # Test: Validate stacks
  - name: secrets-masking validate stacks
    enabled: true
    snapshot: false
    description: "Validate stack configuration for secrets-masking example"
    workdir: "../examples/secrets-masking"
    command: "atmos"
    args:
      - "validate"
      - "stacks"
    expect:
      exit_code: 0
      stdout: []
      stderr: []

  # Test: Describe stacks (snapshot)
  - name: secrets-masking describe stacks
    enabled: true
    snapshot: true
    description: "Describe all stacks in secrets-masking example"
    workdir: "../examples/secrets-masking"
    command: "atmos"
    args:
      - "describe"
      - "stacks"
      - "--format"
      - "json"
    expect:
      exit_code: 0
      valid:
        - "json"
      diff: []

  # Test: Describe config shows mask settings
  - name: secrets-masking describe config
    enabled: true
    snapshot: true
    description: "Verify mask settings are loaded in configuration"
    workdir: "../examples/secrets-masking"
    command: "atmos"
    env:
      ATMOS_PAGER: "false"
    args:
      - "describe"
      - "config"
      - "-f"
      - "json"
    expect:
      exit_code: 0
      valid:
        - "json"
      stdout:
        # Verify mask is enabled
        - '"enabled": true'
        # Verify custom replacement string
        - 'REDACTED'
        # Verify custom patterns are loaded
        - 'demo-key-'
        - 'internal-'
        - 'tkn_'
        # Verify literals are loaded
        - 'super-secret-demo-value'
        - 'my-api-key-12345'
      diff:
        - "github_token"

  # Test: Terraform plan (mock component)
  - name: secrets-masking terraform plan
    enabled: true
    snapshot: false
    description: "Run terraform plan for secrets-demo component"
    workdir: "../examples/secrets-masking"
    command: "atmos"
    args:
      - "terraform"
      - "plan"
      - "secrets-demo"
      - "-s"
      - "demo-dev-test"
    expect:
      exit_code: 0
      stdout:
        - "Plan:"
