# yaml-language-server: $schema=schema.json

tests:
  - name: atmos validate stacks with metadata
    enabled: true
    snapshot: true
    description: "Verify atmos validate stacks command works"
    workdir: "fixtures/scenarios/metadata"
    command: "atmos"
    args:
      - "validate"
      - "stacks"
    expect:
      timeout: 10s
      diff: []
      stdout:
        - "all stacks validated successfully"
      exit_code: 0

  - name: atmos terraform deploy unlocked component
    enabled: true
    snapshot: false
    description: "Verify terraform deploy works on unlocked component"
    workdir: "fixtures/scenarios/metadata"
    command: "atmos"
    args:
      - "terraform"
      - "deploy"
      - "myapp"
      - "-s"
      - "nonprod"
    expect:
      timeout: 1m
      stdout:
        - 'Apply complete! Resources: \d+ added, \d+ changed, \d+ destroyed\.'
      stderr:
        - "^$"
      exit_code: 0

  - name: atmos terraform deploy locked component
    enabled: true
    snapshot: true
    description: "Verify terraform deploy fails on locked component"
    workdir: "fixtures/scenarios/metadata"
    command: "atmos"
    args:
      - "terraform"
      - "deploy"
      - "myapp"
      - "-s"
      - "prod"
    expect:
      timeout: 10s
      stderr:
        - "component 'myapp' is locked and cannot be modified \\(metadata.locked = true\\)"
      exit_code: 1

  - name: atmos terraform plan locked component
    enabled: true
    snapshot: false
    description: "Verify terraform plan works on locked component"
    workdir: "fixtures/scenarios/metadata"
    command: "atmos"
    args:
      - "terraform"
      - "plan"
      - "myapp"
      - "-s"
      - "prod"
    expect:
      timeout: 1m
      stdout:
        - "Terraform has been successfully initialized"
        - "Terraform used the selected providers to generate the following execution"
      stderr:
        - "^$"
      exit_code: 0
