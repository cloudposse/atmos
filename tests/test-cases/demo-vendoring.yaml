# yaml-language-server: $schema=schema.json

tests:
  - name: atmos vendor pull
    enabled: true
    snapshot: false
    tty: true
    description: "Vendoring works with pull command"
    workdir: "../examples/demo-vendoring/"
    command: "atmos"
    args:
      - "vendor"
      - "pull"
    skip:
      # PTY not supported on windows
      os: !not windows
    expect:
      stdout:
        - "Pulling"
        - "github/stargazers"
        - "weather"
        - "Vendored 3 components"
        - "Vendoring from 'vendor.yaml'"
        - !not 'No TTY detected\. Falling back to basic output\.'
      exit_code: 0

  - name: atmos vendor pull (no tty)
    enabled: true
    snapshot: true
    tty: false
    description: "Vendoring works with pull command"
    workdir: "../examples/demo-vendoring/"
    command: "atmos"
    args:
      - "vendor"
      - "pull"
    expect:
      diff: []
      stderr:
        - 'No TTY detected\. Falling back to basic output\.'
      exit_code: 0

  - name: atmos vendor pull using SSH
    enabled: true
    snapshot: true
    tty: false
    description: "Dry-run vendoring with SSH style URL (verified and prepended with SSH prefix by Atmos)"
    workdir: "fixtures/scenarios/vendor-pulls-ssh"
    command: "atmos"
    args:
      - "vendor"
      - "pull"
      - "--logs-level=Debug"
    env:
      ATMOS_GITHUB_TOKEN: "supersecret"
    expect:
      diff: []
      exit_code: 0

  - name: atmos vendor pull with custom detector and handling credentials leakage
    enabled: true
    snapshot: true
    tty: false
    description: "Ensure that injected credentials are never leaked in logs"
    workdir: "fixtures/scenarios/vendor-creds-sanitize"
    command: "atmos"
    args:
      - "vendor"
      - "pull"
      - "--logs-level=Debug"
    env:
      ATMOS_GITHUB_TOKEN: supersecret
    expect:
      diff: []
    stderr:
      - "Injecting token" 
    stdout:
      - "!supersecret"  
      - "!ATMOS_GITHUB_TOKEN"
    exit_code: 0