# yaml-language-server: $schema=https://raw.githubusercontent.com/cloudposse/atmos/refs/heads/main/tests/test-cases/schema.json
tests:
  - name: "Invalid Log Level in Config File"
    enabled: true
    snapshot: true
    description: "Test validation of invalid log level in atmos.yaml config file"
    workdir: "fixtures/scenarios/invalid-log-level"
    command: "atmos"
    args:
      - terraform
      - plan
      - test
      - -s
      - test
    expect:
      timeout: 10s
      diff: []
      exit_code: 1
      stderr:
        - "Error: Invalid log level 'XTrace'\\. Valid options are: \\[Trace, Debug, Info, Warning, Off\\]\n"

  - name: "Invalid Log Level in Environment Variable"
    enabled: true
    snapshot: true
    description: "Test validation of invalid log level in ATMOS_LOGS_LEVEL env var"
    workdir: "../"
    command: "atmos"
    args:
      - terraform
      - plan
      - test
      - -s
      - test
    env:
      ATMOS_LOGS_LEVEL: XTrace
    expect:
      timeout: 10s
      diff: []
      exit_code: 1
      stderr:
        - "Error: Invalid log level 'XTrace' set in the ATMOS_LOGS_LEVEL environment variable\\. Valid options are: \\[Trace, Debug, Info, Warning, Off\\]\n"

  - name: "Valid Log Level in Config File"
    enabled: true
    snapshot: true
    description: "Test validation of valid log level in atmos.yaml config file"
    workdir: "fixtures/scenarios/valid-log-level"
    command: "atmos"
    args:
      - version
    expect:
      diff:
        - '游놓 Atmos (\d+\.\d+\.\d+|test) on [a-z]+/[a-z0-9]+'
      stdout:
        - '^\n游놓 Atmos (\d+\.\d+\.\d+|test) on [a-z]+/[a-z0-9_]+\n\n$'
      exit_code: 0

  - name: "Valid Log Level in Environment Variable"
    enabled: true
    snapshot: true
    description: "Test validation of valid log level in ATMOS_LOGS_LEVEL env var"
    workdir: "../"
    command: "atmos"
    args:
      - version
    env:
      ATMOS_LOGS_LEVEL: Debug
    expect:
      timeout: 10s
      diff:
        - '游놓 Atmos (\d+\.\d+\.\d+|test) on [a-z]+/[a-z0-9]+'
      stdout:
        - '^\n游놓 Atmos (\d+\.\d+\.\d+|test) on [a-z]+/[a-z0-9_]+\n\n$'
      stderr:
        - "DEBU Found ENV var ATMOS_LOGS_LEVEL=Debug"
      exit_code: 0

  - name: "Valid Log Level in Command Line Flag"
    enabled: true
    snapshot: true
    description: "Test validation of valid log level in --logs-level flag"
    workdir: "../"
    command: "atmos"
    args:
      - --logs-level
      - Info
      - version
    expect:
      timeout: 10s
      diff:
        - '游놓 Atmos (\d+\.\d+\.\d+|test) on [a-z]+/[a-z0-9]+'
      stdout:
        - '^\n游놓 Atmos (\d+\.\d+\.\d+|test) on [a-z]+/[a-z0-9_]+\n\n$'
      stderr:
        - "^$"
      exit_code: 0
  - name: "Valid log level in env should be priortized over config"
    enabled: true
    snapshot: true
    description: "Test validation of env priority over config"
    workdir: "../"
    command: "atmos"
    args:
      - version
    env:
      ATMOS_LOGS_LEVEL: "Debug"
    expect:
      diff:
        - '游놓 Atmos (\d+\.\d+\.\d+|test) on [a-z]+/[a-z0-9]+'
      stderr:
        # We are fine with any debug logs config is set to info but if env gets priority we would get debug
        - "DEBU"
      exit_code: 0
  - name: "Valid log level in flag should be priortized over env and config"
    enabled: true
    snapshot: true
    description: "Test validation of env priority over config"
    workdir: "../"
    command: "atmos"
    args:
      - version
      - "--logs-level"
      - "Debug"
    env:
      ATMOS_LOGS_LEVEL: "Info"
    expect:
      diff:
        - '游놓 Atmos (\d+\.\d+\.\d+|test) on [a-z]+/[a-z0-9]+'
      stderr:
        # We are fine with any debug logs config and env is set to info but if flag gets priority we would get debug logs
        - "DEBU"
      exit_code: 0
  - name: "Valid log file in env should be priortized over config"
    enabled: true
    snapshot: true
    description: "Test validation of env priority over config"
    workdir: "../"
    command: "atmos"
    args:
      - version
      - "--logs-level"
      - "Debug"
    env:
      ATMOS_LOGS_FILE: "/dev/stdout"
    expect:
      diff:
        - '游놓 Atmos (\d+\.\d+\.\d+|test) on [a-z]+/[a-z0-9]+'
      stdout:
        # Debug logs should be in stdout as we have choosen /dev/stdout in env
        - "DEBU"
      exit_code: 0
  - name: "Valid log file in flag should be priortized over env and config"
    enabled: true
    snapshot: true
    description: "Test validation of env priority over config"
    workdir: "../"
    command: "atmos"
    args:
      - version
      - "--logs-level"
      - "Debug"
      - "--logs-file"
      - "/dev/stdout"
    env:
      ATMOS_LOGS_FILE: "/dev/stderr"
    expect:
      diff:
        - '游놓 Atmos (\d+\.\d+\.\d+|test) on [a-z]+/[a-z0-9]+'
      stdout:
        # Debug logs should be in stdout as we have choosen /dev/stdout in flag
        - "DEBU"
      exit_code: 0
