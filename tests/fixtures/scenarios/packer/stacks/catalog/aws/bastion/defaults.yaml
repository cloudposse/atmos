# yaml-language-server: $schema=https://atmos.tools/schemas/atmos/atmos-manifest/1.0/atmos-manifest.json

# https://developer.hashicorp.com/packer/integrations/hashicorp/amazon/latest/components/builder/ebs
# https://masterminds.github.io/sprig/date.html

components:
  packer:
    aws/bastion:
      settings:
        ami:
          source_ami: "ami-0013ceeff668b979b"
          source_ami_name: "al2023-ami-2023.7.20250527.1-kernel-6.12-arm64"
          source_ami_description: "Amazon Linux 2023 AMI 2023.7.20250527.1 arm64 HVM kernel-6.12"
          source_ami_owner_account_id: "137112412989"
          region: "us-east-2"
          org_id: "o-xxxxxxxx"
          org_management_account_id: "xxxxxxxxxxxx"
      metadata:
        component: aws/bastion
      vars:
        # https://masterminds.github.io/sprig/date.html
        ami_name: "bastion-al2023-{{ now | unixEpoch }}"
        source_ami: "{{ .settings.ami.source_ami }}"
        region: "{{ .settings.ami.region }}"
        org_arn: "arn:aws:organizations::{{ .settings.ami.org_management_account_id }}:organization/{{ .settings.ami.org_id }}"
        kms_key_arn: null
        encrypt_boot: false
        ssh_username: "ec2-user"
        associate_public_ip_address: true
        volume_type: "gp3"
        skip_create_ami: false
        manifest_file_name: "manifest.json"
        manifest_strip_path: false
        assume_role_session_name: "atmos-packer"
        assume_role_duration_seconds: 1800
        ami_tags:
          SourceAMI: "{{ .settings.ami.source_ami }}"
          SourceAMIName: "{{ .settings.ami.source_ami_name }}"
          SourceAMIDescription: "{{ .settings.ami.source_ami_description }}"
          SourceAMIOwnerAccountId: "{{ .settings.ami.source_ami_owner_account_id }}"
          ScanStatus: pending
