# Test stack for verifying nested AuthManager propagation through !terraform.state functions.
#
# This fixture tests:
# 1. AuthManager and AuthContext propagate correctly through multiple levels
# 2. Components without auth config inherit parent's AuthManager
#
# Note: Component-level auth sections are NOT included because:
# - Tests use mocked AuthManager which is passed directly to ExecuteDescribeComponent
# - Auth sections would try to authenticate with non-existent providers during stack processing
# - The mock AuthManager handles all auth context propagation in the tests

vars:
  stage: test

components:
  terraform:
    # ============================================================================
    # SCENARIO 1: Basic Nested Propagation (No Auth Overrides)
    # ============================================================================

    # Level 3: Base component (no nested functions)
    level3-component:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        subnet_id: "subnet-level3-12345"
        cidr_block: "10.0.3.0/24"
      backend:
        local:
          path: "level3/terraform.tfstate"

    # Level 2: References level3-component
    level2-component:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        # Nested function: triggers evaluation of level3-component
        level3_subnet_id: !terraform.state level3-component test subnet_id
        level3_cidr: !terraform.state level3-component test cidr_block
        vpc_id: "vpc-level2-67890"
      backend:
        local:
          path: "level2/terraform.tfstate"

    # Level 1: References level2-component
    # Uses global/parent auth for entire chain
    level1-component:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        # Nested function: triggers evaluation of level2-component
        # which in turn triggers evaluation of level3-component
        level2_vpc_id: !terraform.state level2-component test vpc_id
        level2_subnet: !terraform.state level2-component test level3_subnet_id
        app_name: "test-app"
      backend:
        local:
          path: "level1/terraform.tfstate"

    # ============================================================================
    # SCENARIO 2: Auth Override at Level 2 (Middle Level)
    # Note: Auth handled by mock AuthManager in tests
    # ============================================================================

    # Base component for auth override scenario
    auth-override-level3:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        database_host: "db.example.com"
        database_port: 5432
      backend:
        local:
          path: "auth-override-level3/terraform.tfstate"

    # Level 2 - auth would be overridden here (handled by mock)
    auth-override-level2:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        database_config: !terraform.state auth-override-level3 test database_host
        service_name: "api-service"
      backend:
        local:
          path: "auth-override-level2/terraform.tfstate"

    # Level 1 that triggers auth override at level 2
    auth-override-level1:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        api_endpoint: !terraform.state auth-override-level2 test service_name
        api_database: !terraform.state auth-override-level2 test database_config
      backend:
        local:
          path: "auth-override-level1/terraform.tfstate"

    # ============================================================================
    # SCENARIO 3: Multiple Auth Overrides in Chain
    # Note: Auth handled by mock AuthManager in tests
    # ============================================================================

    # Base component (account A)
    multi-auth-level3:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        shared_resource_id: "shared-12345"
        region: "us-east-1"
      backend:
        local:
          path: "multi-auth-level3/terraform.tfstate"

    # Level 2 (account B)
    multi-auth-level2:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        shared_resource: !terraform.state multi-auth-level3 test shared_resource_id
        vpc_id: "vpc-account-b"
      backend:
        local:
          path: "multi-auth-level2/terraform.tfstate"

    # Level 1 (account C)
    multi-auth-level1:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        vpc_reference: !terraform.state multi-auth-level2 test vpc_id
        shared_reference: !terraform.state multi-auth-level2 test shared_resource
      backend:
        local:
          path: "multi-auth-level1/terraform.tfstate"

    # ============================================================================
    # SCENARIO 4: Selective Auth Override (Mixed Inheritance)
    # Note: Auth handled by mock AuthManager in tests
    # ============================================================================

    # Component that inherits parent auth (no override)
    mixed-inherit-component:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        config_value: "inherited-auth-config"
      backend:
        local:
          path: "mixed-inherit/terraform.tfstate"

    # Component that overrides auth
    mixed-override-component:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        inherited_value: !terraform.state mixed-inherit-component test config_value
        override_value: "override-specific-value"
      backend:
        local:
          path: "mixed-override/terraform.tfstate"

    # Top-level component referencing both
    mixed-top-level:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        value_from_inherit: !terraform.state mixed-inherit-component test config_value
        value_from_override: !terraform.state mixed-override-component test override_value
      backend:
        local:
          path: "mixed-top-level/terraform.tfstate"

    # ============================================================================
    # SCENARIO 5: Deep Nesting with Auth Override at Multiple Levels
    # Note: Auth handled by mock AuthManager in tests
    # ============================================================================

    # Level 4 (deepest) - no auth override
    deep-level4:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        data_source: "primary-db"
      backend:
        local:
          path: "deep-level4/terraform.tfstate"

    # Level 3 - auth override
    deep-level3:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        data_ref: !terraform.state deep-level4 test data_source
      backend:
        local:
          path: "deep-level3/terraform.tfstate"

    # Level 2 - no auth override (inherits from level3)
    deep-level2:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        nested_data: !terraform.state deep-level3 test data_ref
      backend:
        local:
          path: "deep-level2/terraform.tfstate"

    # Level 1 - auth override
    deep-level1:
      metadata:
        component: mock
        type: real
      vars:
        stage: test
        final_data: !terraform.state deep-level2 test nested_data
      backend:
        local:
          path: "deep-level1/terraform.tfstate"
