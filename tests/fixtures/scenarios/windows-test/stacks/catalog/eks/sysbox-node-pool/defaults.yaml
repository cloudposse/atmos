components:
  terraform:
    eks/sysbox-node-pool:
      metadata:
        component: eks/karpenter-node-pool
      settings:
        depends_on:
          1:
            component: "eks/karpenter"
          2:
            component: "eks/sysbox-runtime"
      vars:
        enabled: true
        eks_component_name: eks/cluster
        name: "sysbox-node-pool"
        node_pools:
          sysbox:
            private_subnets_enabled: true
            annotations: null
            # Labels for Sysbox workload scheduling
            # - sysbox-install=yes: DaemonSet targets this label to install CRI-O + Sysbox
            # - sandbox-runtime=sysbox: For workload scheduling
            labels:
              sysbox-install: "yes"
              sandbox-runtime: sysbox
              workload: sandbox
            # Taint per requirements: sandbox-runtime=sysbox:NoSchedule
            taints:
              - key: "sandbox-runtime"
                value: "sysbox"
                effect: "NoSchedule"
            disruption:
              consolidation_policy: "WhenEmptyOrUnderutilized"
              consolidate_after: "5m"
              max_instance_lifetime: "336h" # 14 days
              budgets:
                - nodes: "20%"
                  reasons:
                    - "Underutilized"
                    - "Empty"
            # Resource limits for Sysbox node pool
            total_cpu_limit: "100"
            total_memory_limit: "500Gi"
            metadata_options: {}
            # IMPORTANT: Sysbox requires Ubuntu (not Amazon Linux)
            # Ubuntu 22.04 (Jammy) EKS AMI from Canonical
            # Owner: 099720109477 (Canonical)
            # See: https://cloud-images.ubuntu.com/docs/aws/eks/
            # Using amiFamily: Custom for Ubuntu with explicit bootstrap
            ami_family: "Custom"
            ami_selector_terms:
              # Ubuntu 22.04 EKS AMI for K8s 1.31 (1.33 AMIs may not exist yet)
              # EKS supports minor version skew for kubelet (1.31 kubelet works with 1.33 control plane)
              - name: "ubuntu-eks/k8s_1.31/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"
                owner: "099720109477"
            # Larger root volume for nested container images
            # Ubuntu uses /dev/sda1 as root device
            block_device_mappings:
              - deviceName: /dev/sda1
                ebs:
                  volumeSize: 300Gi
                  volumeType: gp3
                  encrypted: true
                  deleteOnTermination: true
            requirements:
              # CRITICAL: This requirement tells Karpenter this NodePool can satisfy
              # pods requiring sysbox-install=yes (from RuntimeClass nodeSelector)
              - key: "sysbox-install"
                operator: "In"
                values: ["yes"]
              - key: "karpenter.k8s.aws/instance-encryption-in-transit-supported"
                operator: "In"
                values: ["true"]
              # Sysbox requires 4+ vCPUs per Nestybox docs
              - key: "karpenter.k8s.aws/instance-cpu"
                operator: Gt
                values: ["3"]
              - key: "karpenter.k8s.aws/instance-cpu"
                operator: Lt
                values: ["32"]
              # Use on-demand for stability with sandbox workloads
              - key: "karpenter.sh/capacity-type"
                operator: "In"
                values:
                  - "on-demand"
              - key: "kubernetes.io/arch"
                operator: "In"
                values:
                  - "amd64"
              # Instance families that support Sysbox well
              - key: "karpenter.k8s.aws/instance-family"
                operator: "In"
                values:
                  - c6i
                  - c6id
                  - c7i
                  - m6i
                  - m6id
                  - m7i
                  - m7i-flex
                  - r6i
                  - r6id
                  - r7i
            # Simple bootstrap for Custom AMI
            # DaemonSet (sysbox-deploy-k8s) will install CRI-O and Sysbox after node joins
            # Labels and taints must be passed via kubelet-extra-args for Custom AMI
            # MIME multipart format required for Karpenter with Custom amiFamily
            # NOTE: Update the cluster name to match your EKS cluster name
            user_data: |
              MIME-Version: 1.0
              Content-Type: multipart/mixed; boundary="==BOUNDARY=="

              --==BOUNDARY==
              Content-Type: text/x-shellscript; charset="us-ascii"

              #!/bin/bash
              set -ex
              /etc/eks/bootstrap.sh ${EKS_CLUSTER_NAME} \
                --kubelet-extra-args '--node-labels=sysbox-install=yes,sandbox-runtime=sysbox,workload=sandbox --register-with-taints=sandbox-runtime=sysbox:NoSchedule'

              --==BOUNDARY==--

        kube_exec_auth_role_arn_enabled: false
        kube_exec_auth_role_arn: ""
