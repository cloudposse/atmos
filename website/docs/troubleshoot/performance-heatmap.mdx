---
title: Performance Heatmap
sidebar_position: 3
sidebar_label: Performance Heatmap
description: Visualize Atmos performance metrics with interactive heatmaps and detailed function timing analysis.
---

import Terminal from '@site/src/components/Terminal'
import File from '@site/src/components/File'
import Intro from '@site/src/components/Intro'

<Intro>
    Atmos includes a built-in performance heatmap feature that provides real-time visualization of function execution times and call statistics.
    This lightweight profiling tool helps identify performance bottlenecks without the overhead of full pprof profiling.
</Intro>

## What is Performance Heatmap?

The performance heatmap is a lightweight profiling visualization tool that tracks and displays:

- **Function call counts**: How many times each function is called
- **Execution times**: Total, average, and maximum duration for each function (microsecond precision)
- **Percentile statistics**: P95 latency for detailed performance analysis
- **Interactive visualizations**: Multiple display modes for analyzing performance data

Unlike pprof profiling which captures detailed runtime data, the heatmap provides focused, real-time metrics on
instrumented functions with minimal overhead. All timing measurements use microsecond precision to capture fast function executions.

## Quick Start

Display the performance heatmap after command execution:

```shell
# Run any Atmos command with the --heatmap flag
atmos describe stacks --heatmap
```

This will launch an interactive TUI (Terminal User Interface) where you can switch between different visualization modes by pressing 1-4.

### Example: Real Performance Analysis

Here's a real example of analyzing performance with `atmos describe stacks --heatmap`:

**Bar Chart View** (Press `1` in interactive mode):

![Performance Heatmap - Bar Chart](/img/cli/perf/atmos-describe-stacks-heatmap-bar-chart.png)

The bar chart shows the top 25 functions by execution time, making it easy to identify performance bottlenecks at a glance.

**Function Times View** (Press `2` in interactive mode):

![Performance Heatmap - Function Times](/img/cli/perf/atmos-describe-stacks-heatmap-func-times.png)

The ASCII heatmap provides a color-coded visualization of execution times across all tracked functions.

**Non-Interactive Mode** (when running in CI/CD or scripts):

<Terminal title="Performance heatmap output">
    ```
    === Atmos Performance Summary ===
    Elapsed: 54.164125ms  Functions: 42  Calls: 5980
    Function                                            Count      Total        Avg        Max      P95
    exec.ProcessYAMLConfigFileWithContext                  52    7.488ms      144µs      760µs    662µs
    exec.Execute                                            1    6.233ms    6.233ms    6.233ms  6.235ms
    exec.ValidateStacks                                     1    5.499ms    5.499ms    5.499ms  5.499ms
    merge.MergeWithOptions                                746    4.561ms        6µs      654µs     21µs
    utils.processCustomTags                              1024     4.27ms        4µs      146µs     15µs
    utils.GetHighlightedYAML                                1     3.86ms     3.86ms     3.86ms  3.861ms
    utils.HighlightCodeWithConfig                           1    3.545ms    3.545ms    3.545ms  3.545ms
    merge.MergeWithContext                                356    3.123ms        8µs      655µs     29µs
    merge.MergeWithOptionsAndContext                      356    3.052ms        8µs      654µs     29µs
    utils.ConvertToYAML                                   177      2.5ms       14µs      309µs     56µs
    exec.ProcessStackConfig                                12    1.926ms      160µs      367µs    186µs
    utils.GetGlobMatches                                   48    1.859ms       38µs      418µs    226µs
    merge.Merge                                           390    1.728ms        4µs      154µs     21µs
    exec.FindStacksMap                                      2     1.61ms      805µs    1.035ms  1.035ms
    exec.ProcessYAMLConfigFiles                             2    1.594ms      797µs     1.02ms   1.02ms
    config.FindAllStackConfigsInPaths                       1    1.045ms    1.045ms    1.045ms  1.045ms
    exec.ProcessYAMLConfigFile                              8      914µs      114µs      222µs    222µs
    exec.ExecuteDescribeStacks                              1      662µs      662µs      662µs    662µs
    exec.GetFileContent                                    52      511µs        9µs       73µs     54µs
    exec.getEmbeddedSchemaPath                              1      266µs      266µs      266µs    266µs
    utils.SliceContainsString                            2456      148µs          0        6µs        -
    utils.PathMatch                                        32       58µs        1µs        2µs      2µs
    exec.ProcessImportSection                              52       57µs        1µs       15µs      4µs
    exec.processSettingsIntegrationsGithub                 30       26µs          0        9µs      6µs
    utils.JoinPaths                                         5       24µs        4µs       22µs     22µs
    utils.EnsureDir                                         1       22µs       22µs       22µs     22µs
    utils.GetHighlightSettings                              2       19µs        9µs       18µs     18µs
    exec.createComponentStackMap                            2       12µs        6µs       12µs     12µs
    utils.ResolveRelativePath                              32       10µs          0        4µs        -
    exec.ProcessCommandLineArgs                             1        8µs        8µs        8µs      8µs
    utils.IsTemplateFile                                   52        5µs          0        2µs        -
    exec.FindComponentsDerivedFromBaseComponents           10        4µs          0          0        -
    utils.UniqueStrings                                    38        4µs          0          0        -
    utils.getLexer                                          1        4µs        4µs        4µs      4µs
    utils.IsDirectory                                       1        4µs        4µs        4µs      4µs
    config.matchesStackFilePattern                          4        3µs          0        3µs      3µs
    utils.JoinPath                                         11        3µs          0          0        -
    exec.BuildTerraformWorkspace                           10        3µs          0        1µs      1µs
    config.processEnvVars                                   2        2µs        1µs        1µs      1µs
    ```
</Terminal>

## Configuration

### CLI Flags

<dl>
    <dt>`--heatmap`</dt>
    <dd>Display performance heatmap visualization after command execution (includes P95 latency tracking)</dd>

    <dt>`--heatmap-mode`</dt>
    <dd>Visualization mode: `bar`, `ascii`, `table`, or `sparkline` (default: `bar`). In interactive mode, press 1-4 to switch modes.</dd>
</dl>

**Basic usage:**
```bash
atmos terraform plan vpc -s dev --heatmap
```

## Visualization Modes

The heatmap supports multiple visualization modes for analyzing performance data.
In interactive mode (when a TTY is available), you can switch between modes by pressing 1-4:

1. **Bar Chart** - Horizontal bars showing relative execution times
2. **ASCII Heatmap** - Color-coded grid visualization
3. **Sparklines** - Compact sparkline charts
4. **Table** - Detailed tabular view with all metrics

### Bar Chart Mode (Default)

Horizontal bar chart showing relative execution times:

```shell
atmos describe stacks --heatmap --heatmap-mode=bar
```

<Terminal title="Bar chart visualization">
    ```
    🔥 Performance Heatmap - Bar Chart
    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    ProcessStackConfig    ████████████████████████ 120ms
    LoadYAMLFile          ████████████ 65ms
    ProcessTemplates      ████████ 42ms
    ValidateConfig        ███ 18ms
    MergeOverrides        ██ 12ms
    ```
</Terminal>

### ASCII Heatmap Mode

Color-coded grid showing performance distribution across functions:

```shell
atmos describe stacks --heatmap --heatmap-mode=ascii
```

<Terminal title="ASCII heatmap visualization">
    ```
    🔥 Performance Heatmap - ASCII Heat Map
    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    ProcessStackConfig  ████████
    LoadYAMLFile        ████░░░░
    ProcessTemplates    ███░░░░░
    ValidateConfig      ██░░░░░░
    MergeOverrides      █░░░░░░░

    Color Legend: █ >1s  █ >500ms  █ >100ms  █ <100ms
    ```
</Terminal>

### Sparkline Mode

Compact sparkline charts for quick overview:

```shell
atmos describe stacks --heatmap --heatmap-mode=sparkline
```

<Terminal title="Sparkline visualization">
    ```
    🔥 Performance Heatmap - Sparklines
    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    ProcessStackConfig     ▁▂▃▅▇█▆▄▃▂ 120ms (45 calls)
    LoadYAMLFile          ▁▂▄▆█▅▃▂▁  65ms (32 calls)
    ProcessTemplates      ▂▃▅█▆▄▂▁   42ms (28 calls)
    ValidateConfig        ▃▅█▅▃▁     18ms (18 calls)
    MergeOverrides        ▄█▅▂       12ms (12 calls)

    Press 1-4 to switch modes | q to quit
    ```
</Terminal>

### Table Mode

Detailed tabular view with all metrics:

```shell
atmos describe stacks --heatmap --heatmap-mode=table
```

<Terminal title="Table visualization">
    ```
    🔥 Performance Heatmap - Table View
    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    ┌─────────────────────────────────────┬───────┬──────────┬──────────┬──────────┬─────────┐
    │ Function                            │ Count │ Total    │ Avg      │ Max      │ P95     │
    ├─────────────────────────────────────┼───────┼──────────┼──────────┼──────────┼─────────┤
    │ ProcessStackConfig                  │    45 │   120ms  │    2ms   │    8ms   │   6ms   │
    │ LoadYAMLFile                        │    32 │    65ms  │    2ms   │    5ms   │   4ms   │
    │ ProcessTemplates                    │    28 │    42ms  │    1ms   │    3ms   │   2ms   │
    │ ValidateComponentConfig             │    18 │    18ms  │    1ms   │    2ms   │   2ms   │
    │ MergeOverrides                      │    12 │    12ms  │    1ms   │    2ms   │   1ms   │
    └─────────────────────────────────────┴───────┴──────────┴──────────┴──────────┴─────────┘

    Press 1-4 to switch modes | q to quit
    ```
</Terminal>

## Output Explanation

### Performance Summary

The summary section shows aggregate metrics:

```
=== Atmos Performance Summary ===
Elapsed: 234.56ms  Functions: 12  Calls: 156
```

- **Elapsed**: Total execution time for the command
- **Functions**: Number of unique functions tracked
- **Calls**: Total number of function calls tracked

### Function Metrics

Each tracked function displays:

<dl>
    <dt>`Function`</dt>
    <dd>Name of the tracked function</dd>

    <dt>`Count`</dt>
    <dd>Number of times the function was called</dd>

    <dt>`Total`</dt>
    <dd>Total time spent in all calls to this function</dd>

    <dt>`Avg`</dt>
    <dd>Average execution time per call (Total ÷ Count)</dd>

    <dt>`Max`</dt>
    <dd>Maximum execution time for a single call</dd>

    <dt>`P95`</dt>
    <dd>95th percentile latency (automatically calculated when tracking is enabled)</dd>
</dl>

### Interactive Mode

When running in a terminal with TTY support, the heatmap launches an interactive UI:

**Keyboard Controls:**
- **1**: Switch to Bar Chart mode
- **2**: Switch to ASCII Heatmap mode
- **3**: Switch to Sparkline mode
- **4**: Switch to Table mode
- **q/esc**: Quit and return to terminal

**Non-TTY Mode:**
When running in scripts or CI/CD pipelines without a TTY, the heatmap displays a static summary instead of launching the interactive UI.

## Common Use Cases

### Identifying Slow Functions

Track which functions consume the most execution time:

```bash
# Profile a slow command with percentile statistics
atmos terraform plan large-component -s prod --heatmap

# Look for functions with high Total time in the output
```

Focus optimization efforts on functions with:
- High **Total** time (most impact on overall performance)
- High **Max** time (individual slow calls)
- High **P95** time (consistent slowness)

### Comparing Performance

Compare performance before and after optimizations:

```bash
# Baseline measurement
atmos describe stacks --heatmap 2>baseline.txt

# After optimization
atmos describe stacks --heatmap 2>optimized.txt

# Compare the Total times for key functions
diff baseline.txt optimized.txt
```

### CI/CD Integration

Capture performance metrics in automated pipelines:

```bash
# In CI/CD pipeline - run commands and capture metrics
atmos terraform plan vpc -s prod --heatmap 2>&1 | tee performance.log

# Parse performance.log for regression detection
```

### Development Workflow

Use during development to validate performance impact:

```bash
# Create an alias for convenient heatmap usage
alias atmos-perf='atmos --heatmap'

# Run commands with heatmap during development
atmos-perf validate stacks
atmos-perf describe component vpc -s dev
```

## Performance Heatmap vs. pprof Profiling

Choose the right tool for your use case:

| Feature            | Performance Heatmap            | pprof Profiling                       |
|--------------------|--------------------------------|---------------------------------------|
| **Overhead**       | Minimal (microsecond tracking) | Higher (full runtime instrumentation) |
| **Granularity**    | Function-level metrics         | Line-level profiling                  |
| **Setup**          | CLI flag only (`--heatmap`)    | Requires flags or config              |
| **Output**         | Real-time visualization        | File or HTTP endpoint                 |
| **Use Case**       | Quick performance checks       | Deep performance analysis             |
| **Visualization**  | Built-in interactive UI        | Requires `go tool pprof`              |
| **Data Retention** | In-memory (command lifetime)   | Persistent files                      |

**When to use Performance Heatmap:**
- Quick performance validation during development
- Identifying which functions are called most often
- Comparing execution times between commands
- Lightweight monitoring in production

**When to use pprof Profiling:**
- Deep dive into performance bottlenecks
- CPU and memory usage analysis
- Detailed goroutine and allocation profiling
- Flame graph visualization

See [Performance Profiling](/troubleshoot/profiling) for pprof usage.

## Limitations

### Current Limitations

1. **Instrumentation Required**: Only tracks functions that have been instrumented with `perf.Track()` calls
2. **In-Memory Only**: Metrics are not persisted between command executions
3. **No Historical Data**: Cannot compare performance across multiple runs (use pprof for this)
4. **Terminal-Dependent**: Interactive mode requires a TTY (scripts get static output)

### Planned Enhancements

The performance heatmap feature is under active development. Future enhancements may include:

- Automatic instrumentation of critical paths
- Historical performance tracking
- Performance regression detection
- Export to various formats (JSON, CSV)
- Integration with observability platforms

## Troubleshooting

### Heatmap Not Showing

**Problem**: Running `--heatmap` flag but no performance data is displayed.

**Solution**: The `--heatmap` flag should always display the performance summary. If you're not seeing it, ensure you're using the latest version of Atmos:
```bash
atmos version --heatmap
```

**Expected Output:**
```
=== Atmos Performance Summary ===
```

### No Functions Tracked

**Problem**: Heatmap shows "Functions: 0  Calls: 0"

**Explanation**: The current command hasn't executed any instrumented functions yet. Performance tracking is being added incrementally to Atmos functions.

**Workaround**: Run commands that process stacks and components, which have more instrumentation:
```bash
atmos describe stacks --heatmap
atmos terraform plan component -s stack --heatmap
```

### P95 Column Shows Zero

**Problem**: P95 column displays `0` or unusually low values

**Explanation**: P95 calculations require multiple function calls to be statistically meaningful. If a function is only called once or twice, P95 may not be representative.

**Expected Behavior**: Run commands that execute functions multiple times to see meaningful P95 values:
```bash
atmos describe stacks --heatmap
atmos terraform plan component -s stack --heatmap
```

### Interactive Mode Not Working

**Problem**: TUI doesn't launch, shows "No TTY available" message

**Explanation**: The heatmap requires a terminal (TTY) for interactive mode. This happens in:
- Shell scripts running in background
- CI/CD pipelines
- Redirected output (`atmos cmd --heatmap > file.txt`)

**Expected Behavior**: Static summary is displayed instead:
```
=== Atmos Performance Summary ===
Elapsed: 123.45ms  Functions: 5  Calls: 42
...
⚠️  No TTY available for interactive visualization. Summary displayed above.
```

### Combining with pprof

**Problem**: Can I use both performance heatmap and pprof profiling simultaneously?

**Solution**: Yes, they are independent and can be used together:
```bash
# Run with both heatmap and pprof profiling
atmos terraform plan vpc -s prod \
  --heatmap \
  --profile-file=cpu.prof \
  --profile-type=cpu

# View heatmap summary after command
# Then analyze detailed pprof data
go tool pprof -http=:8080 cpu.prof
```

## Best Practices

### Use When Needed

Performance tracking is only enabled when the `--heatmap` flag is used, ensuring zero overhead during normal operations:

```bash
# Development: Use heatmap when investigating performance
atmos terraform plan vpc -s prod --heatmap

# CI/CD: Enable conditionally for performance regression testing
if [ "$ENABLE_PERF_TRACKING" = "true" ]; then
  atmos terraform plan vpc -s prod --heatmap 2>perf.log
fi
```

### Use Appropriate Modes

Choose visualization mode based on your context:

- **bar**: Best for identifying relative performance differences
- **ascii**: Best for visual pattern recognition
- **sparkline**: Best for quick overview of many functions
- **table**: Best for detailed metric analysis

### Combine with Logging

Correlate performance metrics with debug logs:

```bash
# Run with debug logging and performance heatmap
atmos describe stacks \
  --logs-level=Debug \
  --heatmap \
  2>&1 | tee debug-with-perf.log
```

### Automate Regression Detection

Track performance in CI/CD to detect regressions:

```bash
#!/bin/bash
# ci-performance-check.sh

# Capture performance metrics
atmos validate stacks --heatmap 2>&1 | tee perf-output.txt

# Extract elapsed time
elapsed=$(grep "Elapsed:" perf-output.txt | awk '{print $2}')

# Compare with baseline (e.g., 500ms)
if [ $(echo "$elapsed > 500" | bc) -eq 1 ]; then
  echo "Performance regression detected: ${elapsed} > 500ms"
  exit 1
fi
```

## Related Documentation

- [Performance Profiling](/troubleshoot/profiling) - Deep performance analysis with pprof
- [Error Messages](/troubleshoot/errors) - Common error messages and solutions
