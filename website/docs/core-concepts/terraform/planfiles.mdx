---
title: Terraform Planfiles
sidebar_label: Planfiles
sidebar_position: 5
id: planfiles
---
import Terminal from '@site/src/components/Terminal'
import Intro from '@site/src/components/Intro'

<Intro>
Atmos provides sophisticated planfile management for Terraform, enabling safe and predictable infrastructure changes through plan generation, storage, and application workflows.
</Intro>

## Overview

A Terraform planfile is a binary file that contains the exact set of changes Terraform will make to your infrastructure. Atmos enhances Terraform's native planfile functionality by:

- **Standardizing planfile naming and storage**
- **Enabling seamless plan-and-apply workflows**
- **Supporting both automatic and custom planfile management**
- **Integrating with CI/CD pipelines and approval workflows**

## How Atmos Manages Planfiles

### Automatic Planfile Generation

When you run `atmos terraform plan`, Atmos automatically:

1. **Generates a planfile** with a standardized name
2. **Stores it** in the component's working directory
3. **Makes it available** for subsequent apply operations

The planfile naming convention follows this pattern:

```
# Without folder prefix
<context>-<component>.planfile

# With folder prefix
<context>-<folder_prefix>-<component>.planfile

# Examples:
dev-vpc.planfile
prod-us-east-1-database.planfile
staging-platform-kubernetes.planfile
```

### Planfile Storage Location

Planfiles are stored in the component's working directory:

```
components/
└── terraform/
    └── vpc/
        ├── main.tf
        ├── variables.tf
        ├── outputs.tf
        └── dev-vpc.planfile  # Generated planfile
```

## Working with Planfiles

### Basic Plan and Apply Workflow

The most common workflow is to generate a plan, review it, and then apply it:

<Terminal>
```bash
# Step 1: Generate a plan (automatically creates a planfile)
$ atmos terraform plan vpc -s dev

# Review the plan output...

# Step 2: Apply the exact plan that was generated
$ atmos terraform apply vpc -s dev --from-plan
```
</Terminal>

### Custom Planfile Locations

You can specify custom locations for planfiles using the standard Terraform `-out` flag:

<Terminal>
```bash
# Generate plan to a custom location
$ atmos terraform plan vpc -s dev -out=/tmp/my-vpc-plan.tfplan

# Apply the custom planfile
$ atmos terraform apply vpc -s dev --planfile /tmp/my-vpc-plan.tfplan
```
</Terminal>

### Skipping Planfile Generation

In some cases, you may want to run a plan without generating a planfile:

<Terminal>
```bash
# Quick plan check without saving
$ atmos terraform plan vpc -s dev --skip-planfile

# Or configure globally in atmos.yaml
```
</Terminal>

```yaml title="atmos.yaml"
components:
  terraform:
    plan:
      skip_planfile: true  # Disable planfile generation globally
```

## Planfile Flags and Options

### Plan Command Flags

| Flag | Description | Example |
|------|-------------|---------|
| `-out=FILE` | Save plan to specific file | `atmos terraform plan vpc -s dev -out=my.plan` |
| `--skip-planfile` | Skip planfile generation | `atmos terraform plan vpc -s dev --skip-planfile` |

### Apply Command Flags

| Flag | Description | Example |
|------|-------------|---------|
| `--from-plan` | Use Atmos-generated planfile | `atmos terraform apply vpc -s dev --from-plan` |
| `--planfile FILE` | Use specific planfile | `atmos terraform apply vpc -s dev --planfile my.plan` |

## CI/CD Integration

### GitHub Actions Example

Planfiles are essential for safe CI/CD deployments. Here's a typical workflow:

```yaml title=".github/workflows/terraform.yml"
name: Terraform Deployment

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main]

jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Atmos
        uses: cloudposse/github-action-setup-atmos@v2

      - name: Generate Plan
        run: |
          atmos terraform plan vpc -s prod -out=vpc-prod.plan

      - name: Upload Planfile
        uses: actions/upload-artifact@v3
        with:
          name: terraform-plan
          path: components/terraform/vpc/vpc-prod.plan

  apply:
    needs: plan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Download Planfile
        uses: actions/download-artifact@v3
        with:
          name: terraform-plan
          path: components/terraform/vpc/

      - name: Apply Plan
        run: |
          atmos terraform apply vpc -s prod --planfile vpc-prod.plan
```

### GitLab CI Example

```yaml title=".gitlab-ci.yml"
stages:
  - plan
  - apply

plan:
  stage: plan
  script:
    - atmos terraform plan vpc -s prod
  artifacts:
    paths:
      - components/terraform/vpc/prod-vpc.planfile
    expire_in: 1 day

apply:
  stage: apply
  dependencies:
    - plan
  script:
    - atmos terraform apply vpc -s prod --from-plan
  only:
    - main
  when: manual  # Require manual approval
```

## Terraform Cloud Integration

Terraform Cloud doesn't support the `-out` flag for planfiles. When using Terraform Cloud:

### Configuration

```yaml title="atmos.yaml"
components:
  terraform:
    plan:
      skip_planfile: true  # Required for Terraform Cloud
```

### Environment Variable

```bash
export ATMOS_COMPONENTS_TERRAFORM_PLAN_SKIP_PLANFILE=true
```

### Command Line

```bash
atmos terraform plan vpc -s dev --skip-planfile
```

## Advanced Use Cases

### Plan Comparison

Compare two different plans using `atmos terraform plan-diff`:

<Terminal>
```bash
# Generate first plan
$ atmos terraform plan vpc -s dev -out=plan1.tfplan

# Make some configuration changes...

# Generate second plan
$ atmos terraform plan vpc -s dev -out=plan2.tfplan

# Compare the plans
$ atmos terraform plan-diff vpc -s dev --orig=plan1.tfplan --new=plan2.tfplan
```
</Terminal>

### JSON/YAML Planfiles

Generate planfiles in JSON or YAML format for integration with other tools:

<Terminal>
```bash
# Generate JSON planfile
$ atmos terraform generate planfile vpc -s dev --format=json

# Generate YAML planfile
$ atmos terraform generate planfile vpc -s dev --format=yaml

# Use with security scanning tools
$ atmos terraform generate planfile vpc -s dev --format=json
$ checkov --file dev-vpc.planfile.json --framework terraform_plan
```
</Terminal>

### Multi-Component Workflows

Apply plans for multiple components in sequence:

```bash
#!/bin/bash
# generate-and-apply-all.sh

components=("vpc" "database" "kubernetes" "application")
stack="prod"

# Generate all plans
for component in "${components[@]}"; do
  echo "Planning $component..."
  atmos terraform plan "$component" -s "$stack"
done

# Review and apply
read -p "Apply all plans? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
  for component in "${components[@]}"; do
    echo "Applying $component..."
    atmos terraform apply "$component" -s "$stack" --from-plan
  done
fi
```

## Best Practices

### 1. Always Review Plans

Never apply infrastructure changes without reviewing the plan first:

```bash
# Good: Plan, review, then apply
atmos terraform plan vpc -s prod
# ... review the output ...
atmos terraform apply vpc -s prod --from-plan

# Avoid: Direct apply without review (except in dev)
atmos terraform apply vpc -s prod -auto-approve
```

### 2. Use Planfiles in Production

For production deployments, always use planfiles to ensure consistency:

```bash
# Production workflow
atmos terraform plan app -s prod -out=prod-$(date +%Y%m%d-%H%M%S).plan
# Get approval...
atmos terraform apply app -s prod --planfile prod-20240115-143022.plan
```

### 3. Clean Up Old Planfiles

Planfiles can contain sensitive information. Clean them up regularly:

```bash
# Clean component directory (removes planfiles and varfiles)
atmos terraform clean vpc -s dev

# Or manually remove old planfiles
find components/terraform -name "*.planfile" -mtime +7 -delete
```

### 4. Secure Planfile Storage

When storing planfiles in CI/CD:

- **Encrypt planfiles** at rest and in transit
- **Set appropriate retention periods** (typically 1-7 days)
- **Restrict access** to planfiles containing sensitive data
- **Never commit planfiles** to version control

### 5. Validate Plans Before Applying

Use tools to validate planfiles before applying:

```bash
# Generate planfile in JSON format
atmos terraform generate planfile vpc -s prod --format=json

# Validate with Checkov
checkov --file prod-vpc.planfile.json --framework terraform_plan

# Validate with OPA
opa eval -d policies/ -i prod-vpc.planfile.json "data.terraform.deny[msg]"
```

## Troubleshooting

### Common Issues

#### Planfile Not Found

```bash
Error: Planfile not found at expected location
```

**Solution**: Ensure you've run `atmos terraform plan` first, or check the planfile path.

#### Stale Planfile

```bash
Error: Saved plan is stale; either terraform.tfstate was modified, or the plan file is out of date
```

**Solution**: Regenerate the plan with `atmos terraform plan`.

#### Terraform Cloud Compatibility

```bash
Error: Run variables are currently not supported
```

**Solution**: Use `--skip-planfile` flag or configure `skip_planfile: true` in `atmos.yaml`.

### Debugging

Enable debug logging to see planfile operations:

```bash
# Enable debug logs
export ATMOS_LOGS_LEVEL=Debug

# Run commands
atmos terraform plan vpc -s dev
atmos terraform apply vpc -s dev --from-plan
```

## Related Documentation

- [`atmos terraform plan`](/cli/commands/terraform/terraform-plan) - Plan command reference
- [`atmos terraform apply`](/cli/commands/terraform/terraform-apply) - Apply command reference
- [`atmos terraform deploy`](/cli/commands/terraform/terraform-deploy) - Deploy command reference
- [`atmos terraform plan-diff`](/cli/commands/terraform/terraform-plan-diff) - Plan comparison
- [`atmos terraform generate planfile`](/cli/commands/terraform/terraform-generate-planfile) - Generate JSON/YAML planfiles
- [Terraform Configuration](/cli/configuration/components#terraform) - Configure Terraform behavior
