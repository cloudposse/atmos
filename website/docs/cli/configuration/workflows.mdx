---
title: Workflows
sidebar_label: workflows
sidebar_class_name: command
description: Configure the base path for Atmos workflow definitions.
id: workflows
slug: /cli/configuration/workflows
---
import Intro from '@site/src/components/Intro'
import File from '@site/src/components/File'
import DocCardList from '@theme/DocCardList'

<Intro>
Configure where Atmos looks for workflow definition files. Workflows allow you to automate sequences of Atmos commands and other operations.
</Intro>

## Configuration

Workflows are configured in the `workflows` section:

<File title="atmos.yaml">
```yaml
workflows:
  # Can also be set using 'ATMOS_WORKFLOWS_BASE_PATH' ENV var, or '--workflows-dir' command-line argument
  # Supports both absolute and relative paths
  base_path: "stacks/workflows"
```
</File>

## Configuration Options

<dl>
  <dt>`workflows.base_path`</dt>
  <dd>
    Base path to Atmos workflow definition files. Supports both absolute and relative paths. When `base_path` is set in the root configuration, this path is relative to it. Can also be set using `ATMOS_WORKFLOWS_BASE_PATH` environment variable or `--workflows-dir` command-line argument.
  </dd>
</dl>

## Directory Structure

A typical workflows directory structure:

```
stacks/workflows/
├── deploy.yaml
├── destroy.yaml
├── validate.yaml
└── maintenance/
    ├── backup.yaml
    └── rotate-credentials.yaml
```

## Example Workflow File

<File title="stacks/workflows/deploy.yaml">
```yaml
workflows:
  deploy-vpc:
    description: Deploy VPC to all environments
    steps:
      - command: terraform apply vpc -s plat-ue2-dev --auto-approve
      - command: terraform apply vpc -s plat-ue2-staging --auto-approve
      - command: terraform apply vpc -s plat-ue2-prod --auto-approve

  deploy-all:
    description: Deploy all infrastructure
    steps:
      - command: workflow deploy-vpc
      - command: terraform apply eks-cluster -s plat-ue2-dev --auto-approve
      - command: terraform apply eks-cluster -s plat-ue2-staging --auto-approve
      - command: terraform apply eks-cluster -s plat-ue2-prod --auto-approve
```
</File>

## Working Directory

Workflows support a `working_directory` setting that controls where steps execute. This can be set at both the workflow level (applies to all steps) and individual step level (overrides workflow setting).

### Path Resolution

- **Absolute paths** are used as-is (e.g., `/tmp`)
- **Relative paths** are resolved against the Atmos `base_path`
- The `!repo-root` YAML function can dynamically resolve to the git repository root

### Example: Workflow-Level Working Directory

<File title="stacks/workflows/build.yaml">
```yaml
workflows:
  build-all:
    description: Build from repository root
    working_directory: !repo-root
    steps:
      - command: make build
        type: shell
      - command: make test
        type: shell
```
</File>

All steps inherit the workflow's `working_directory` setting.

### Example: Step-Level Override

<File title="stacks/workflows/download.yaml">
```yaml
workflows:
  download-and-install:
    description: Download files to /tmp, then install from repo root
    working_directory: !repo-root
    steps:
      - command: wget https://example.com/archive.tar.gz
        working_directory: /tmp
        type: shell
      - command: tar -xzf /tmp/archive.tar.gz
        type: shell
      - command: make install
        type: shell
```
</File>

The first step overrides the workflow setting to run in `/tmp`, while subsequent steps use the workflow-level `working_directory` (repo root).

### Example: Mixed Atmos and Shell Commands

<File title="stacks/workflows/mixed.yaml">
```yaml
workflows:
  deploy-and-verify:
    description: Deploy infrastructure and run verification scripts
    steps:
      - command: terraform apply vpc
        stack: plat-ue2-dev
      - command: ./scripts/verify-vpc.sh
        working_directory: !repo-root
        type: shell
```
</File>

:::tip
Use `working_directory` when your workflow includes shell commands that depend on relative file paths, or when you need to run commands like `terraform import` directly in a component directory.
:::

## Workflow Environment Variables

Workflows support an `env` map for setting environment variables that are passed to step commands. This can be set at both the workflow level (applies to all steps) and individual step level (overrides workflow setting for the same keys).

### Environment Variable Precedence

Environment variables are merged in this order (later values override earlier):

1. System environment (`os.Environ()`)
2. Global env from `atmos.yaml`
3. Workflow-level `env`
4. Step-level `env`
5. Auth identity environment (if `identity` specified)

### Example: Workflow-Level Environment

<File title="stacks/workflows/deploy.yaml">
```yaml
workflows:
  deploy-with-env:
    description: Deploy with common environment variables
    env:
      TF_LOG: DEBUG
      AWS_REGION: us-east-2
    steps:
      - command: terraform apply vpc -s plat-ue2-dev --auto-approve
      - command: terraform apply eks-cluster -s plat-ue2-dev --auto-approve
```
</File>

All steps inherit the workflow's `env` settings.

### Example: Step-Level Override

<File title="stacks/workflows/mixed-env.yaml">
```yaml
workflows:
  deploy-multi-region:
    description: Deploy to multiple regions
    env:
      TF_LOG: INFO
    steps:
      - command: terraform apply vpc -s plat-ue2-dev --auto-approve
        env:
          AWS_REGION: us-east-2
      - command: terraform apply vpc -s plat-uw2-dev --auto-approve
        env:
          AWS_REGION: us-west-2
```
</File>

Each step overrides `AWS_REGION` while inheriting `TF_LOG` from the workflow level.

### Example: Shell Commands with Environment

<File title="stacks/workflows/script.yaml">
```yaml
workflows:
  run-scripts:
    description: Run shell scripts with custom environment
    env:
      LOG_LEVEL: debug
      OUTPUT_DIR: /tmp/results
    steps:
      - command: ./scripts/setup.sh
        type: shell
      - command: ./scripts/validate.sh
        type: shell
        env:
          STRICT_MODE: "true"
```
</File>

:::tip
Use workflow-level `env` for common settings like logging levels, and step-level `env` for step-specific configuration.
:::

### Environment Variable Scoping

Environment variables in workflows are **scoped to individual steps**. This means:

- **Workflow-level `env`** applies to all steps in the workflow
- **Step-level `env`** only applies to that specific step and does **not** persist to subsequent steps
- **Shell exports** (`export VAR=value`) within a step do **not** persist to subsequent steps

Each step runs as a separate subprocess, so variables set or modified within a step are isolated to that step.

<File title="stacks/workflows/scoping-example.yaml">
```yaml
workflows:
  env-scoping-demo:
    description: Demonstrates environment variable scoping
    env:
      FOO: workflow
    steps:
      # Step 1: FOO = "workflow" (from workflow-level env)
      - command: echo "Workflow FOO - $FOO"
        type: shell

      # Step 2: FOO = "stepEnv" (step-level override)
      - command: echo "Step Env FOO - $FOO"
        type: shell
        env:
          FOO: stepEnv

      # Step 3: FOO = "workflow" (step env does NOT persist)
      - command: echo "Step Env not persisted - $FOO"
        type: shell

      # Step 4: FOO = "exported" (only within this step's process)
      - command: export FOO=exported && echo "Local export FOO - $FOO"
        type: shell

      # Step 5: FOO = "workflow" (shell export does NOT persist)
      - command: echo "Local export not persisted - $FOO"
        type: shell
```
</File>

Running this workflow produces:

```
Workflow FOO - workflow
Step Env FOO - stepEnv
Step Env not persisted - workflow
Local export FOO - exported
Local export not persisted - workflow
```

:::caution
If you need to pass values between steps, consider writing to a file in a shared directory, or use workflow-level environment variables that are set before the workflow runs.
:::

## CLI Environment Variables

<dl>
  <dt>`ATMOS_WORKFLOWS_BASE_PATH`</dt>
  <dd>Base path to Atmos workflow definitions.</dd>
</dl>

## Related Commands

<DocCardList items={[
  {type: 'link', href: '/cli/commands/workflow', label: 'atmos workflow', description: 'Execute Atmos workflows'},
  {type: 'link', href: '/cli/commands/list/list-workflows', label: 'atmos list workflows', description: 'List available workflows'},
]} />

## See Also

- [CLI Configuration](/cli/configuration) — Overview of CLI configuration
- [Workflows](/workflows) — Complete guide to Atmos workflows
