---
slug: file-scoped-locals-fix
title: 'Fixed: File-Scoped Locals Now Resolve Templates Correctly'
authors:
  - aknysh
tags:
  - bugfix
date: 2026-01-06T00:00:00.000Z
---

The file-scoped locals feature introduced in v1.203.0 now correctly resolves `{{ .locals.* }}` templates in stack configurations.
Previously, locals were defined but not integrated into the template processing pipeline, causing templates to remain unresolved.

<!--truncate-->

## The Problem

When using file-scoped locals as documented, templates referencing locals were not being resolved:

```yaml
# stacks/prod.yaml
locals:
  namespace: acme
  environment: prod
  name_prefix: "{{ .locals.namespace }}-{{ .locals.environment }}"

components:
  terraform:
    myapp:
      vars:
        name: "{{ .locals.name_prefix }}-myapp"
        stage: "{{ .locals.environment }}"
```

Running `atmos describe component` showed raw template strings instead of resolved values:

```yaml
# Before fix - templates not resolved
vars:
  name: "{{ .locals.name_prefix }}-myapp"
  stage: "{{ .locals.environment }}"
```

## The Fix

Atmos now correctly resolves locals before template processing. The same configuration now produces the expected output:

```yaml
# After fix - templates resolved correctly
vars:
  name: "acme-prod-myapp"
  stage: "prod"
```

### What Changed

1. **Locals extraction** - Raw YAML is now parsed to extract `locals:` sections before template processing
2. **Template context** - Resolved locals are added to the template context so `{{ .locals.* }}` references work
3. **Section override tracking** - Section-specific locals (in `terraform:`, `helmfile:`, `packer:`) correctly override global locals

### New Command: `atmos describe locals`

A new command has been added to help inspect and debug locals configurations:

```bash
# Show locals for all stacks
atmos describe locals

# Show locals for a specific stack (using file path)
atmos describe locals --stack deploy/dev

# Show locals for a specific stack (using logical stack name from atmos.yaml)
atmos describe locals --stack prod-us-east-1

# Show locals available to a specific component in a stack
atmos describe locals vpc -s prod

# Output as JSON
atmos describe locals --format json

# Write to file
atmos describe locals --file locals.yaml
```

The `--stack` flag accepts either a **stack manifest file path** (e.g., `deploy/dev`) or a **logical stack name** derived from your `atmos.yaml` naming pattern (e.g., `prod-us-east-1`). Both resolve to the same underlying file, and locals are returned from that file only.

#### Component-Specific Locals

When specifying a component with the `--stack` flag, the command shows the merged locals that would be **available to** that component during template processing. The component argument determines which section-specific locals to include (e.g., `terraform:` locals for a Terraform component), but the locals themselves come from the stack manifest file, not the component definition:

```bash
atmos describe locals vpc -s prod
```

```yaml
component: vpc
stack: prod
component_type: terraform
locals:
  namespace: acme
  environment: prod
  backend_bucket: acme-prod-tfstate
```

The `component_type` field shows how Atmos determined which section-specific locals to merge with global locals.

#### Stack-Level Output

Without a component argument, the output is organized by scope:

```yaml
deploy/dev:
  global:
    namespace: acme
    environment: dev
    name_prefix: acme-dev
  terraform:
    backend_bucket: acme-dev-tfstate
  merged:
    namespace: acme
    environment: dev
    name_prefix: acme-dev
    backend_bucket: acme-dev-tfstate
```

- **global** - Root-level locals from the stack file
- **terraform/helmfile/packer** - Section-specific locals (only shown if defined)
- **merged** - All locals merged together (global first, then sections)

### Section-Specific Locals

Locals can be defined at multiple levels, with later scopes overriding earlier ones:

```yaml
# Global locals
locals:
  namespace: "global-acme"

terraform:
  # Terraform-scope locals override global
  locals:
    namespace: "terraform-acme"
    backend_bucket: "{{ .locals.namespace }}-tfstate"

components:
  terraform:
    myapp:
      vars:
        # Uses terraform-scope value: "terraform-acme-tfstate"
        bucket: "{{ .locals.backend_bucket }}"
```

## Features That Work

All documented locals features now function correctly:

### Locals Referencing Other Locals

```yaml
locals:
  namespace: acme
  environment: prod
  # Resolved in dependency order
  name_prefix: "{{ .locals.namespace }}-{{ .locals.environment }}"
  full_name: "{{ .locals.name_prefix }}-us-east-1"
```

### Circular Dependency Detection

Atmos detects circular dependencies and logs them gracefully:

```yaml
# This triggers a circular dependency warning
locals:
  a: "{{ .locals.b }}"
  b: "{{ .locals.a }}"
```

### Complex Values

Maps and nested structures work as expected:

```yaml
locals:
  common_tags:
    Environment: "{{ .locals.environment }}"
    Namespace: "{{ .locals.namespace }}"

components:
  terraform:
    vpc:
      vars:
        tags: "{{ .locals.common_tags }}"
```

## Supported Scopes

Locals can be defined at two levels:

```yaml
# Global locals (root level) - available throughout the file
locals:
  namespace: acme
  environment: prod

# Section-level locals (terraform/helmfile/packer) - inherit from global
terraform:
  locals:
    backend_bucket: "{{ .locals.namespace }}-{{ .locals.environment }}-tfstate"

components:
  terraform:
    vpc:
      vars:
        # Uses merged locals (global + terraform section)
        bucket: "{{ .locals.backend_bucket }}"
```

## Upgrade

Upgrade Atmos to get this fix. No configuration changes are required.
Your existing `locals:` definitions will automatically start working.

```bash
# View all locals across your stacks
atmos describe locals

# Verify locals are resolving correctly in component output
atmos describe component myapp -s prod --format yaml
```

## References

- [GitHub Issue #1933](https://github.com/cloudposse/atmos/issues/1933)
- [File-Scoped Locals Documentation](/stacks/locals)
- [Original Feature Announcement](/changelog/file-scoped-locals)
