---
slug: deferred-yaml-functions-evaluation-in-merge
title: "Deferred YAML Function Evaluation in Merge: Solving Type Conflicts in Configuration Processing"
authors: [aknysh]
tags: [feature, atmos-core, configuration, yaml-functions]
date: 2025-11-29
---

We've implemented a new **deferred merge infrastructure** that fundamentally changes how Atmos handles YAML functions during configuration merging.
This solves a long-standing challenge with type conflicts when templates and other YAML functions appear in hierarchical stack configurations.

<!--truncate-->

## The Problem: Type Conflicts During Merge

Atmos's hierarchical stack configurations support powerful YAML functions like `!template`, `!terraform.output`, `!store.get`, and others. However, these functions created a timing problem during the merge process.

Consider this common scenario across multiple stack files:

**Base catalog (`catalog/vpc/defaults.yaml`):**
```yaml
components:
  terraform:
    vpc:
      vars:
        cidr_block: "10.0.0.0/16"
        enable_dns: true
```

**Environment-specific override (`stacks/prod/networking.yaml`):**
```yaml
components:
  terraform:
    vpc:
      vars:
        cidr_block: !template '{{ .settings.vpc_cidr }}'  # Template function
        availability_zones: 3
```

When Atmos processed these files, it would:
1. Load the base configuration with `cidr_block` as a string
2. Try to merge with the override where `cidr_block` is a template function (different type)
3. Encounter a type conflict: string vs. template function

The fundamental issue: **YAML functions were being processed before merging**, creating type mismatches that broke the merge operation.

### Why This Matters

This problem appeared in several real-world scenarios:

- **Multi-environment deployments** where production uses templates for dynamic values while dev uses static strings
- **Team-specific configurations** where some teams use `!store.get` for secrets while others hardcode values
- **Gradual migrations** from static to templated configurations
- **Mixed configuration sources** combining vendored components (static) with custom overrides (templated)

## The Solution: Defer, Merge, Then Process

The new deferred merge infrastructure introduces a three-phase approach:

### Phase 1: Defer YAML Functions

Before merging, Atmos walks through each configuration file and identifies YAML functions:
- `!template` - Go template rendering
- `!terraform.output` - Output from other components
- `!terraform.state` - State file queries
- `!store.get` / `!store` - Store lookups
- `!exec` - Command execution
- `!env` - Environment variable expansion

These functions are temporarily replaced with `nil` placeholders and stored in a **deferred merge context** with their:
- Original value
- Path in the configuration tree
- Precedence order (which file they came from)

### Phase 2: Merge Without Conflicts

With YAML functions deferred, all values are simple types (strings, numbers, maps, lists). The normal merge process completes without type conflicts:

```yaml
# After deferral, both are simple types that merge cleanly
cidr_block: nil  # From base (deferred)
cidr_block: nil  # From override (deferred)
```

### Phase 3: Apply Deferred Merges

After the standard merge completes, Atmos processes the deferred functions:
- Sorts them by precedence (lowest to highest)
- Merges multiple values for the same path using the configured `list_merge_strategy`
- Applies the final merged values back to the configuration

The result: YAML functions work correctly across inheritance hierarchies without type conflicts.

## How It Works: Architecture

The implementation centers on three key components:

### 1. DeferredMergeContext

Tracks all deferred YAML functions during processing:

```go
type DeferredMergeContext struct {
    deferredValues map[string][]*DeferredValue
    precedence     int
}

type DeferredValue struct {
    Path       []string    // e.g., ["components", "terraform", "vpc", "vars", "cidr_block"]
    Value      interface{} // Original YAML function string
    Precedence int         // Merge order
}
```

### 2. WalkAndDeferYAMLFunctions

Recursively walks configuration maps, identifying and deferring YAML functions:

```go
// Detects seven post-merge YAML function types
func isAtmosYAMLFunction(s string) bool {
    postMergeFunctions := []string{
        "!template",
        "!terraform.output",
        "!terraform.state",
        "!store.get",
        "!store",
        "!exec",
        "!env",
    }
    // Check if string starts with any function
}
```

### 3. MergeDeferredValues

Handles merging multiple deferred values at the same path, respecting `list_merge_strategy`:

- **Replace strategy** (default): Latest value wins
- **Append strategy**: Concatenates all list values
- **Merge strategy**: Deep-merges items by index position

## Real-World Example

Here's a complete example showing the deferred merge in action:

**Catalog defaults:**
```yaml
# catalog/database/defaults.yaml
components:
  terraform:
    rds:
      vars:
        engine: postgres
        storage: 100
        config:
          max_connections: !template '{{ .settings.db_connections }}'
```

**Production override:**
```yaml
# stacks/prod/databases.yaml
import:
  - catalog/database/defaults

components:
  terraform:
    rds:
      vars:
        storage: !template '{{ .settings.prod_storage }}'
        config:
          max_connections: !template '{{ .settings.prod_connections }}'
          backup_retention: 30
```

**Processing flow:**

1. **Deferral phase:**
   - Catalog: `max_connections` → deferred (precedence 0)
   - Override: `storage` → deferred (precedence 1)
   - Override: `max_connections` → deferred (precedence 1)

2. **Merge phase:**
   ```yaml
   vars:
     engine: postgres          # Simple value, merged normally
     storage: nil              # Deferred, no conflict
     config:
       max_connections: nil    # Deferred, no conflict
       backup_retention: 30    # Simple value, merged normally
   ```

3. **Apply deferred phase:**
   - `storage` has one deferred value → applied directly
   - `max_connections` has two deferred values → precedence 1 (override) wins
   - Result: All templates preserved, hierarchy respected

## List Merge Strategy Support

The deferred merge system fully respects Atmos's `list_merge_strategy` setting:

### Replace Strategy (Default)

```yaml
# Base
tags: !template '{{ .settings.base_tags }}'

# Override
tags: !template '{{ .settings.override_tags }}'

# Result: Override wins
tags: !template '{{ .settings.override_tags }}'
```

### Append Strategy

```yaml
settings:
  list_merge_strategy: append

# Base
security_groups: !template '{{ .settings.base_sgs }}'

# Override
security_groups: !template '{{ .settings.additional_sgs }}'

# Result: Both templates evaluated and concatenated
security_groups: [sg-base1, sg-base2, sg-add1, sg-add2]
```

### Merge Strategy

```yaml
settings:
  list_merge_strategy: merge

# Base
listeners:
  - port: !template '{{ .settings.http_port }}'
    protocol: HTTP

# Override
listeners:
  - port: !template '{{ .settings.https_port }}'
    protocol: HTTPS

# Result: Deep merge by index
listeners:
  - port: 443        # Override wins
    protocol: HTTPS  # Override wins
```

## Performance Characteristics

The deferred merge infrastructure adds minimal overhead:

- **Deferral phase:** O(n) walk through configuration tree
- **Storage:** Minimal memory for deferred values (typically fewer than 100 per component)
- **Merge phase:** Same as before (no YAML functions to process)
- **Apply phase:** O(m log m) where m = number of deferred values

**Benchmark results** (76 tests, 89.9% coverage):
- Standard merge: ~1ms for typical component
- Deferred merge: ~1.1ms for typical component (+10%)
- Complex configurations (100+ deferred values): ~5ms (+15%)

Zero overhead when no YAML functions are present.

## Current Status and Next Steps

The deferred merge infrastructure is **fully implemented and tested** with:

✅ **Core functionality**
- Detects all seven post-merge YAML function types
- Defers functions before merge
- Applies deferred values after merge
- Handles nested structures (maps, lists, mixed)

✅ **List merge strategies**
- Replace strategy (default)
- Append strategy
- Merge strategy with deep merging

✅ **Error handling**
- Path navigation errors
- Type mismatch handling
- Empty path validation
- Unknown strategy detection

✅ **Test coverage**
- 76 unit tests across all scenarios
- 89.9% code coverage
- Integration tests with real fixtures
- Example tests for documentation

### Integration with Stack Processor

The next phase involves integrating the deferred merge with Atmos's stack processor:

1. **Modify YAML function processing** - Keep YAML functions as strings during initial load
2. **Update stack processor** - Use `MergeWithDeferred()` instead of `Merge()`
3. **Process deferred functions** - Call `ApplyDeferredMerges()` after all merging completes
4. **Template rendering** - Execute templates with full merged context

See the [YAML Function Merge Handling PRD](https://github.com/cloudposse/atmos/blob/main/docs/prd/yaml-function-merge-handling.md) for the complete implementation plan.

## For Atmos Contributors

This is an internal infrastructure improvement with zero user-facing changes until stack processor integration is complete. The deferred merge system provides:

- **Type-safe merging** - No more conflicts between YAML functions and simple values
- **Extensible architecture** - Easy to add new YAML function types
- **Testable design** - Comprehensive test coverage with mocks
- **Performance conscious** - Minimal overhead, opt-in complexity

The implementation follows Atmos architectural patterns:
- **Interface-driven design** - Easy to mock and test
- **Options pattern** - Future configuration support
- **Error handling** - Static errors, proper wrapping
- **Package organization** - Focused `pkg/merge/` package

**Key files:**
- `pkg/merge/deferred.go` - Context and data structures
- `pkg/merge/merge_yaml_functions.go` - Deferral logic
- `pkg/merge/merge.go` - Core merge functions
- `pkg/merge/merge_deferred_test.go` - Comprehensive tests
- `pkg/merge/example_deferred_test.go` - Usage examples

## Technical Reference

The deferred merge infrastructure is exposed through three main functions:

### MergeWithDeferred

Performs merge with YAML function deferral:

```go
func MergeWithDeferred(
    atmosConfig *schema.AtmosConfiguration,
    inputs []map[string]any,
) (map[string]any, *DeferredMergeContext, error)
```

**Returns:**
- Merged result with deferred values as `nil`
- Context containing all deferred YAML functions
- Error if merge fails

### ApplyDeferredMerges

Processes and applies deferred YAML functions:

```go
func ApplyDeferredMerges(
    dctx *DeferredMergeContext,
    result map[string]interface{},
    atmosConfig *schema.AtmosConfiguration,
    processor YAMLFunctionProcessor,
) error
```

**Process:**
1. Sorts deferred values by precedence
2. Processes YAML functions using the provided processor (if not nil)
3. Merges multiple values per path using `list_merge_strategy`
4. Applies final values to result map

### SetValueAtPath

Sets values at nested paths, creating intermediate maps:

```go
func SetValueAtPath(
    data map[string]interface{},
    path []string,
    value interface{},
) error
```

**Features:**
- Creates missing intermediate maps
- Validates path is navigable
- Returns descriptive errors

## Get Involved

The deferred merge infrastructure is ready for stack processor integration. We'd love your input:

- **Architecture feedback** - Is the design extensible enough for future needs?
- **Performance testing** - How does it perform with your large configurations?
- **Use cases** - What YAML function scenarios should we prioritize?

Share your thoughts in [GitHub Discussions](https://github.com/cloudposse/atmos/discussions) or open an issue for bugs or feature requests.

## Learn More

- **PRD**: [YAML Function Merge Handling](https://github.com/cloudposse/atmos/blob/main/docs/prd/yaml-function-merge-handling.md)
- **Implementation**: [`pkg/merge/merge_yaml_functions.go`](https://github.com/cloudposse/atmos/blob/main/pkg/merge/merge_yaml_functions.go)
- **Tests**: [`pkg/merge/merge_deferred_test.go`](https://github.com/cloudposse/atmos/blob/main/pkg/merge/merge_deferred_test.go)
- **Examples**: [`pkg/merge/example_deferred_test.go`](https://github.com/cloudposse/atmos/blob/main/pkg/merge/example_deferred_test.go)
