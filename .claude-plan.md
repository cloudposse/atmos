# Plan: Add `--ui` Flag to Terraform Commands

## Summary
Add a `--ui` boolean flag to terraform plan, apply, and deploy commands that:
- Supports `--ui` to enable and `--ui=false` to disable
- Has environment variable binding (`ATMOS_TERRAFORM_UI`)
- Follows the existing flag handling patterns using `flags.NewStandardParser()`
- Supports precedence detection (flag > env > config > default)

## Analysis of Current Architecture

### Flag Handling Pattern
The codebase uses a **unified flag parsing architecture** with `flags.NewStandardParser()`:

1. **Flag Registration (in `init()`):**
   - Create parser with `flags.NewStandardParser()` and flag definitions
   - Register flags with command using `parser.RegisterFlags(cmd)`
   - Bind to Viper for precedence handling using `parser.BindToViper(viper.GetViper())`

2. **Flag Parsing (in `RunE`):**
   - Bind parent parser: `terraformParser.BindFlagsToViper(cmd, v)`
   - Bind subcommand parser: `planParser.BindFlagsToViper(cmd, v)` (or `applyParser`, `deployParser`)
   - Parse options: `opts := ParseTerraformRunOptions(v)`
   - Access values via Viper: `v.GetBool("flag-name")`

3. **Detecting Explicit Flag Usage:**
   - Use `cmd.Flags().Changed("flag-name")` to detect if flag was explicitly set
   - This is needed when you want to distinguish between:
     - User provided `--flag` (Changed = true)
     - User didn't provide flag, using default/env/config (Changed = false)
   - Example from `cmd/list/components.go` (lines 63-75)

### Current Structure

**Files to Modify:**
1. `cmd/terraform/plan.go` - Add `--ui` flag to plan command
2. `cmd/terraform/apply.go` - Add `--ui` flag to apply command
3. `cmd/terraform/deploy.go` - Add `--ui` flag to deploy command
4. `cmd/terraform/options.go` - Add `UI` field to `TerraformRunOptions` struct and parse it in `ParseTerraformRunOptions()`

**Existing Pattern (from plan.go):**
```go
planParser = flags.NewStandardParser(
    WithBackendExecutionFlags(),
    flags.WithBoolFlag("upload-status", "", false, "If set atmos will upload the plan result to the pro API"),
    flags.WithBoolFlag("affected", "", false, "Plan the affected components in dependency order"),
    flags.WithBoolFlag("all", "", false, "Plan all components in all stacks"),
    flags.WithBoolFlag("skip-planfile", "", false, "Skip writing the plan to a file..."),
    flags.WithEnvVars("upload-status", "ATMOS_TERRAFORM_PLAN_UPLOAD_STATUS"),
    flags.WithEnvVars("skip-planfile", "ATMOS_TERRAFORM_PLAN_SKIP_PLANFILE"),
)
```

## Implementation Plan

### Step 1: Add `--ui` flag to plan.go

**Location:** `cmd/terraform/plan.go`

**Modifications to `init()` function (lines 47-65):**
```go
planParser = flags.NewStandardParser(
    WithBackendExecutionFlags(),
    flags.WithBoolFlag("upload-status", "", false, "If set atmos will upload the plan result to the pro API"),
    flags.WithBoolFlag("affected", "", false, "Plan the affected components in dependency order"),
    flags.WithBoolFlag("all", "", false, "Plan all components in all stacks"),
    flags.WithBoolFlag("skip-planfile", "", false, "Skip writing the plan to a file by not passing the `-out` flag to Terraform when executing the command. Set it to true when using Terraform Cloud since the `-out` flag is not supported. Terraform Cloud automatically stores plans in its backend"),
    flags.WithBoolFlag("ui", "", false, "Enable interactive UI mode with enhanced output formatting and status updates"),  // NEW
    flags.WithEnvVars("upload-status", "ATMOS_TERRAFORM_PLAN_UPLOAD_STATUS"),
    flags.WithEnvVars("skip-planfile", "ATMOS_TERRAFORM_PLAN_SKIP_PLANFILE"),
    flags.WithEnvVars("ui", "ATMOS_TERRAFORM_UI"),  // NEW
)
```

**Notes:**
- Flag name: `"ui"`
- No shorthand (empty string)
- Default: `false`
- Description: Explain what the UI mode does
- Environment variable: `ATMOS_TERRAFORM_UI`

### Step 2: Add `--ui` flag to apply.go

**Location:** `cmd/terraform/apply.go`

**Modifications to `init()` function (lines 51-70):**
```go
applyParser = flags.NewStandardParser(
    WithBackendExecutionFlags(),
    flags.WithStringFlag("from-plan", "", "", "Apply from plan file (uses deterministic location if path not specified)"),
    flags.WithNoOptDefVal("from-plan", "true"),
    flags.WithStringFlag("planfile", "", "", "Set the plan file to use"),
    flags.WithBoolFlag("affected", "", false, "Apply the affected components in dependency order"),
    flags.WithBoolFlag("all", "", false, "Apply all components in all stacks"),
    flags.WithBoolFlag("ui", "", false, "Enable interactive UI mode with enhanced output formatting and status updates"),  // NEW
    flags.WithEnvVars("from-plan", "ATMOS_TERRAFORM_APPLY_FROM_PLAN"),
    flags.WithEnvVars("planfile", "ATMOS_TERRAFORM_APPLY_PLANFILE"),
    flags.WithEnvVars("ui", "ATMOS_TERRAFORM_UI"),  // NEW
)
```

### Step 3: Add `--ui` flag to deploy.go

**Location:** `cmd/terraform/deploy.go`

**Modifications to `init()` function (lines 46-68):**
```go
deployParser = flags.NewStandardParser(
    WithBackendExecutionFlags(),
    flags.WithBoolFlag("deploy-run-init", "", false, "If set atmos will run `terraform init` before executing the command"),
    flags.WithStringFlag("from-plan", "", "", "Apply from plan file (uses deterministic location if path not specified)"),
    flags.WithNoOptDefVal("from-plan", "true"),
    flags.WithStringFlag("planfile", "", "", "Set the plan file to use"),
    flags.WithBoolFlag("affected", "", false, "Deploy the affected components in dependency order"),
    flags.WithBoolFlag("all", "", false, "Deploy all components in all stacks"),
    flags.WithBoolFlag("ui", "", false, "Enable interactive UI mode with enhanced output formatting and status updates"),  // NEW
    flags.WithEnvVars("deploy-run-init", "ATMOS_TERRAFORM_DEPLOY_RUN_INIT"),
    flags.WithEnvVars("from-plan", "ATMOS_TERRAFORM_DEPLOY_FROM_PLAN"),
    flags.WithEnvVars("planfile", "ATMOS_TERRAFORM_DEPLOY_PLANFILE"),
    flags.WithEnvVars("ui", "ATMOS_TERRAFORM_UI"),  // NEW
)
```

### Step 4: Update TerraformRunOptions struct

**Location:** `cmd/terraform/options.go`

**Add `UI` field to struct (lines 11-36):**
```go
type TerraformRunOptions struct {
    // Processing flags.
    ProcessTemplates bool
    ProcessFunctions bool
    Skip             []string

    // Execution flags.
    DryRun       bool
    SkipInit     bool
    InitPassVars bool

    // Backend execution flags.
    AutoGenerateBackendFile string
    InitRunReconfigure      string

    // Plan/Apply/Deploy specific flags.
    PlanFile         string
    PlanSkipPlanfile bool
    DeployRunInit    bool
    UI               bool  // NEW: Enable interactive UI mode.

    // Multi-component flags.
    Query      string
    Components []string
    All        bool
    Affected   bool
}
```

**Update `ParseTerraformRunOptions()` function (lines 42-58):**
```go
func ParseTerraformRunOptions(v *viper.Viper) *TerraformRunOptions {
    defer perf.Track(nil, "terraform.ParseTerraformRunOptions")()

    return &TerraformRunOptions{
        ProcessTemplates:        v.GetBool("process-templates"),
        ProcessFunctions:        v.GetBool("process-functions"),
        Skip:                    v.GetStringSlice("skip"),
        DryRun:                  v.GetBool("dry-run"),
        SkipInit:                v.GetBool("skip-init"),
        InitPassVars:            v.GetBool("init-pass-vars"),
        AutoGenerateBackendFile: v.GetString("auto-generate-backend-file"),
        InitRunReconfigure:      v.GetString("init-run-reconfigure"),
        PlanFile:                v.GetString("planfile"),
        PlanSkipPlanfile:        v.GetBool("skip-planfile"),
        DeployRunInit:           v.GetBool("deploy-run-init"),
        UI:                      v.GetBool("ui"),  // NEW
        Query:                   v.GetString("query"),
        Components:              v.GetStringSlice("components"),
        All:                     v.GetBool("all"),
        Affected:                v.GetBool("affected"),
    }
}
```

## Precedence Detection (Optional Enhancement)

If you need to detect whether the flag was **explicitly set** vs using default/env/config, you can use `cmd.Flags().Changed()` in the `RunE` function:

**Example (in plan.go RunE):**
```go
RunE: func(cmd *cobra.Command, args []string) error {
    v := viper.GetViper()

    // Bind both parent and subcommand parsers.
    if err := terraformParser.BindFlagsToViper(cmd, v); err != nil {
        return err
    }
    if err := planParser.BindFlagsToViper(cmd, v); err != nil {
        return err
    }

    // Parse base terraform options.
    opts := ParseTerraformRunOptions(v)

    // Optional: Detect if UI flag was explicitly set
    if cmd.Flags().Changed("ui") {
        // User explicitly provided --ui or --ui=false
        // This takes precedence over env/config
        uiValue := v.GetBool("ui")
        // Do something special if needed
    }

    return terraformRunWithOptions(terraformCmd, cmd, args, opts)
},
```

However, **this is usually not needed** because:
1. Viper already handles precedence (flag > env > config > default)
2. The flag value in `opts.UI` will already reflect the correct precedence
3. Use `Changed()` only when you need tri-state logic (unset vs true vs false)

## Key Architectural Points

### Why This Pattern Works

1. **Automatic Precedence:** Viper handles flag > env > config > default automatically
2. **Type Safety:** StandardParser enforces correct types
3. **Environment Variables:** `WithEnvVars()` binds env vars to Viper
4. **No Direct Binding:** NEVER call `viper.BindEnv()` or `viper.BindPFlag()` directly (Forbidigo enforced)
5. **Consistent Access:** Always access via `v.GetBool("ui")` in RunE and `ParseTerraformRunOptions()`

### Common Pitfalls to Avoid

❌ **DON'T** bind flags directly:
```go
viper.BindPFlag("ui", cmd.Flags().Lookup("ui"))  // FORBIDDEN
```

❌ **DON'T** use different env var names per command:
```go
flags.WithEnvVars("ui", "ATMOS_TERRAFORM_PLAN_UI")  // Inconsistent!
```

✅ **DO** use the same env var across all commands:
```go
flags.WithEnvVars("ui", "ATMOS_TERRAFORM_UI")  // Consistent!
```

✅ **DO** use Viper for all flag access:
```go
ui := v.GetBool("ui")  // Correct
```

## Testing Considerations

After implementation, verify:
1. ✅ `atmos terraform plan vpc -s dev --ui` sets UI=true
2. ✅ `atmos terraform plan vpc -s dev --ui=false` sets UI=false
3. ✅ `atmos terraform plan vpc -s dev` (no flag) uses default (false)
4. ✅ `ATMOS_TERRAFORM_UI=true atmos terraform plan vpc -s dev` sets UI=true
5. ✅ Flag takes precedence: `ATMOS_TERRAFORM_UI=false atmos terraform plan vpc -s dev --ui` sets UI=true (flag wins)
6. ✅ Same behavior for apply and deploy commands
7. ✅ `make lint` passes
8. ✅ `go build .` compiles successfully

## Files Modified

1. `cmd/terraform/plan.go` - Add `--ui` flag to planParser
2. `cmd/terraform/apply.go` - Add `--ui` flag to applyParser
3. `cmd/terraform/deploy.go` - Add `--ui` flag to deployParser
4. `cmd/terraform/options.go` - Add `UI` field and parsing logic

## Questions for User

1. **Description:** What should the help text for the `--ui` flag say? Current suggestion: "Enable interactive UI mode with enhanced output formatting and status updates"

2. **Default Value:** Should the default be `false` (requiring explicit opt-in) or should it check some config value?

3. **Scope:** Should this flag ONLY be on plan/apply/deploy, or should it also be added to other terraform subcommands (init, workspace, etc.)?

4. **Precedence Detection:** Do you need special handling when the flag is explicitly set vs using default/env/config, or is standard Viper precedence sufficient?
