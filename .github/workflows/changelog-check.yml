name: Changelog Check
on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  check-changelog:
    name: Check for changelog entry
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check if PR has minor or major label and targets main
        id: check-labels
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          LABELS=$(gh pr view $PR_NUMBER --json labels --jq '.labels[].name')

          # Only require changelog for PRs targeting main branch
          if [ "$BASE_REF" != "main" ]; then
            echo "requires_changelog=false" >> $GITHUB_OUTPUT
            echo "✅ PR does not target main branch - changelog entry not required"
            exit 0
          fi

          if echo "$LABELS" | grep -qE '^(minor|major)$'; then
            echo "requires_changelog=true" >> $GITHUB_OUTPUT
            echo "PR targets main and has minor or major label - changelog entry required"
          else
            echo "requires_changelog=false" >> $GITHUB_OUTPUT
            echo "PR does not have minor or major label - changelog entry not required"
          fi

      - name: Check for new blog post
        if: steps.check-labels.outputs.requires_changelog == 'true'
        id: check-blog
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          BASE_REF="${{ github.event.pull_request.base.sha }}"
          HEAD_REF="${{ github.event.pull_request.head.sha }}"

          # Use git diff directly instead of gh pr diff to avoid API limitations
          # GitHub's diff API has a limit of ~300 files or ~3000 lines, which fails on large PRs
          # git diff works locally without these limitations
          echo "Checking for blog post files between $BASE_REF and $HEAD_REF"
          NEW_BLOG_FILES=$(git diff --name-only "$BASE_REF" "$HEAD_REF" | grep -E '^website/blog/.*\.(md|mdx)$' | grep -v 'tags.yml' || true)

          if [ -z "$NEW_BLOG_FILES" ]; then
            echo "has_changelog=false" >> $GITHUB_OUTPUT
            echo "❌ No changelog entry found"
          else
            echo "has_changelog=true" >> $GITHUB_OUTPUT
            echo "✅ Changelog entry found:"
            echo "$NEW_BLOG_FILES"
          fi

      - name: Comment on PR if changelog missing
        if: steps.check-labels.outputs.requires_changelog == 'true' && steps.check-blog.outputs.has_changelog == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Check if comment already exists
          EXISTING_COMMENT=$(gh pr view $PR_NUMBER --json comments --jq '.comments[] | select(.body | contains("<!-- changelog-check -->")) | .id' | head -1)

          COMMENT_BODY="<!-- changelog-check -->
          > [!WARNING]
          > #### Changelog Entry Required
          >
          > This PR is labeled \`minor\` or \`major\` but doesn't include a changelog entry.
          >
          > **Action needed:** Add a new blog post in \`website/blog/\` to announce this change.
          >
          > Example filename: \`website/blog/$(date +%Y-%m-%d)-feature-name.mdx\`
          >
          > **Alternatively:** If this change doesn't require a changelog entry, remove the \`minor\` or \`major\` label."

          if [ -n "$EXISTING_COMMENT" ]; then
            echo "Updating existing comment..."
            gh pr comment $PR_NUMBER --edit-last --body "$COMMENT_BODY"
          else
            echo "Creating new comment..."
            gh pr comment $PR_NUMBER --body "$COMMENT_BODY"
          fi

      - name: Update comment with success message if changelog added
        if: steps.check-labels.outputs.requires_changelog == 'true' && steps.check-blog.outputs.has_changelog == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          BASE_REF="${{ github.event.pull_request.base.sha }}"
          HEAD_REF="${{ github.event.pull_request.head.sha }}"

          # Get list of blog files added (using git diff to avoid API limitations)
          BLOG_FILES=$(git diff --name-only "$BASE_REF" "$HEAD_REF" | grep -E '^website/blog/.*\.(md|mdx)$' | grep -v 'tags.yml' || true)

          # Find existing comment (warning or success)
          EXISTING_COMMENT=$(gh pr view $PR_NUMBER --json comments --jq '.comments[] | select(.body | contains("<!-- changelog-check -->")) | .id' | head -1)
          EXISTING_COMMENT_BODY=$(gh pr view $PR_NUMBER --json comments --jq '.comments[] | select(.body | contains("<!-- changelog-check -->")) | .body' | head -1)

          SUCCESS_COMMENT_BODY="<!-- changelog-check -->
          > [!NOTE]
          > #### Changelog Added ✅
          >
          > $(echo "$BLOG_FILES" | sed 's/^/- `/' | sed 's/$/`/')
          >
          > Thank you!"

          if [ -n "$EXISTING_COMMENT" ]; then
            # Check if comment already shows success
            if echo "$EXISTING_COMMENT_BODY" | grep -q "Changelog Added ✅"; then
              echo "ℹ️ Comment already shows success - no update needed"
            else
              echo "Updating existing comment with success message..."
              gh api -X PATCH "/repos/${{ github.repository }}/issues/comments/$EXISTING_COMMENT" \
                -f body="$SUCCESS_COMMENT_BODY" || {
                echo "⚠️ Failed to update comment (it may have been deleted)"
              }
              echo "✅ Comment updated from warning to success"
            fi
          else
            echo "ℹ️ No existing comment to update (comment only created when changelog is missing)"
          fi

      - name: Fail if changelog missing
        if: steps.check-labels.outputs.requires_changelog == 'true' && steps.check-blog.outputs.has_changelog == 'false'
        run: |
          echo "❌ ERROR: PR is labeled 'minor' or 'major' but no changelog entry was found."
          echo ""
          echo "Please add a new blog post file in website/blog/ to announce this change."
          echo "Example: website/blog/YYYY-MM-DD-feature-name.mdx"
          echo ""
          echo "If this change should not require a changelog entry, please remove the 'minor' or 'major' label."
          exit 1

      - name: Success
        if: steps.check-labels.outputs.requires_changelog == 'false' || steps.check-blog.outputs.has_changelog == 'true'
        run: |
          if [ "${{ steps.check-labels.outputs.requires_changelog }}" = "false" ]; then
            echo "✅ No changelog entry required for this PR"
          else
            echo "✅ Changelog entry found - check passed"
          fi
