# PRD: Toolchain Lock File Support

## Overview

Add native lock file support for the Atmos toolchain to provide deterministic, cryptographically verifiable tool installations. While `.tool-versions` (ASDF format) is useful for version tracking, a native lock file enables stronger guarantees around reproducibility, security, and multi-platform support.

## Motivation

### Current Limitations of `.tool-versions`

1. **No checksum verification** - Cannot verify download integrity
2. **No platform-specific versions** - Single version for all OS/arch combinations
3. **No dependency metadata** - Cannot track tool dependencies or requirements
4. **Limited security** - No cryptographic verification of binaries
5. **Not Atmos-native** - Designed for ASDF, not optimized for Atmos use cases

### Industry Inspiration

**Go (`go.sum`)**:
- Cryptographic checksums for every dependency
- Verifies integrity before use
- Platform-independent but includes module hashes

**Terraform (`terraform.lock.hcl`)**:
- Platform-specific hashes (multiple OS/arch combinations)
- Tracks provider versions and checksums
- Human-readable HCL format
- Verifies on every run

**NPM (`package-lock.json`)**:
- Exact versions with checksums (integrity field)
- Dependency tree with resolved versions
- Ensures identical installs across environments

**Cargo (`Cargo.lock`)**:
- Exact versions of all dependencies
- Checksums for verification
- Automatically updated on dependency changes

## Goals

1. **Deterministic installations** - Same lock file produces identical toolchain setup
2. **Security verification** - Validate tool integrity via checksums
3. **Multi-platform support** - Lock versions per OS/architecture combination
4. **ASDF compatibility** - Coexist with `.tool-versions` (both serve different purposes)
5. **Developer experience** - Clear, readable YAML format
6. **Automatic management** - Lock file auto-generated and updated

## Non-Goals

1. Replacing `.tool-versions` - Both files serve different purposes and should coexist:
   - `.tool-versions` - Simple version tracking, ASDF compatibility, human-edited
   - `toolchain.lock.yaml` - Security, checksums, multi-platform, auto-managed
2. Managing tool dependencies (tools remain independent)
3. Supporting semver ranges in lock file (exact versions only)
4. Network-based lock file sharing (file is committed to repo)
5. GPG/PGP signing in initial version (planned for future enhancement)

## Design

### Lock File Location

```
<toolchain.install_path>/toolchain.lock.yaml
```

Default: `.tools/toolchain.lock.yaml`

Configurable via:
```yaml
toolchain:
  install_path: .tools
  lock_file: .tools/toolchain.lock.yaml  # Optional, defaults to install_path/toolchain.lock.yaml
```

### Lock File Format

```yaml
# Generated by Atmos Toolchain
# This file locks tool versions and checksums for reproducible installations
# Do not edit manually - run 'atmos toolchain lock' to update

version: 1  # Lock file format version

tools:
  hashicorp/terraform:
    version: 1.13.4
    source: https://github.com/aquaproj/aqua-registry/tree/main/pkgs
    platforms:
      darwin_amd64:
        url: https://releases.hashicorp.com/terraform/1.13.4/terraform_1.13.4_darwin_amd64.zip
        checksum: sha256:a1b2c3d4e5f6...
        size: 95842304
      darwin_arm64:
        url: https://releases.hashicorp.com/terraform/1.13.4/terraform_1.13.4_darwin_arm64.zip
        checksum: sha256:f6e5d4c3b2a1...
        size: 93123456
      linux_amd64:
        url: https://releases.hashicorp.com/terraform/1.13.4/terraform_1.13.4_linux_amd64.zip
        checksum: sha256:1a2b3c4d5e6f...
        size: 98765432
      windows_amd64:
        url: https://releases.hashicorp.com/terraform/1.13.4/terraform_1.13.4_windows_amd64.zip
        checksum: sha256:6f5e4d3c2b1a...
        size: 99123456
    binary_name: terraform
    installed_at: "2025-10-24T14:30:00Z"

  opentofu/opentofu:
    version: 1.10.6
    source: https://github.com/aquaproj/aqua-registry/tree/main/pkgs
    platforms:
      darwin_amd64:
        url: https://github.com/opentofu/opentofu/releases/download/v1.10.6/tofu_1.10.6_darwin_amd64.zip
        checksum: sha256:abc123def456...
        size: 89123456
      darwin_arm64:
        url: https://github.com/opentofu/opentofu/releases/download/v1.10.6/tofu_1.10.6_darwin_arm64.zip
        checksum: sha256:def456abc123...
        size: 87654321
    binary_name: tofu
    installed_at: "2025-10-24T14:31:00Z"

metadata:
  generated_at: "2025-10-24T14:31:00Z"
  atmos_version: "1.96.0"
  platform: darwin_arm64
  lock_file_version: 1
```

### Field Descriptions

#### Top Level
- **`version`** (int, required) - Lock file format version (starts at 1)
- **`tools`** (map, required) - Map of tool identifiers to tool configurations
- **`metadata`** (object, required) - Lock file metadata

#### Tool Entry
- **`version`** (string, required) - Exact version installed (e.g., "1.13.4")
- **`source`** (string, required) - Registry source URL where tool was resolved
- **`platforms`** (map, required) - Platform-specific download information
- **`binary_name`** (string, required) - Name of the binary executable
- **`installed_at`** (RFC3339, required) - When this tool was first locked

#### Platform Entry
- **`url`** (string, required) - Download URL for this platform
- **`checksum`** (string, required) - Checksum in format "algorithm:hash" (e.g., "sha256:abc123...")
- **`size`** (int, required) - File size in bytes

#### Metadata
- **`generated_at`** (RFC3339, required) - When lock file was last updated
- **`atmos_version`** (string, required) - Atmos version that generated the lock file
- **`platform`** (string, required) - Platform that generated the lock file (format: `GOOS_GOARCH`)
- **`lock_file_version`** (int, required) - Lock file format version

### Configuration Options

```yaml
toolchain:
  # Install path for toolchain binaries
  install_path: .tools

  # Lock file location (optional, defaults to install_path/toolchain.lock.yaml)
  lock_file: .tools/toolchain.lock.yaml

  # Enable/disable lock file support (default: true)
  use_lock_file: true

  # Enable/disable .tool-versions support (default: true)
  use_tool_versions: true

  # Verify checksums on every tool execution (default: true)
  verify_checksums: true

  # Fail on checksum mismatch (default: true, set false to warn only)
  strict_checksums: true

  # Versions file (ASDF format)
  versions_file: .tool-versions

  # Registries
  registries:
    - name: aqua-public
      type: aqua
      source: https://github.com/aquaproj/aqua-registry/tree/main/pkgs
      priority: 10
```

## Behavior

### Installation Flow

```
1. User runs: atmos toolchain install terraform@1.13.4

2. Resolve tool from registries
   - Query registries by priority
   - Find hashicorp/terraform@1.13.4

3. Get platform-specific download URL
   - Detect current platform (darwin_arm64, linux_amd64, etc.)
   - Build download URL with platform variables
   - Fetch checksums if available from registry/release

4. Download and verify
   - Download binary/archive
   - Verify checksum if available
   - Extract if needed

5. Update lock file
   - Add/update tool entry
   - Record version, URL, checksum, size
   - Include all known platform variants (from registry metadata)
   - Update metadata (generated_at, etc.)

6. Update .tool-versions (if enabled)
   - Add/update tool version
   - Maintain ASDF compatibility

7. Install binary
   - Copy to install_path/bin/owner/repo/version/
   - Make executable
```

### Lock File Generation

**Command**: `atmos toolchain lock`

Generates lock file from current installation state:

```bash
# Generate lock file from installed tools
atmos toolchain lock

# Generate lock file from .tool-versions
atmos toolchain lock --from-versions-file

# Update lock file with latest checksums
atmos toolchain lock --update

# Regenerate entire lock file
atmos toolchain lock --regenerate
```

### Verification Flow

```
1. User runs tool (e.g., via atmos terraform apply)

2. Check lock file exists
   - If missing and use_lock_file=true, warn or fail

3. Load lock file entry for tool
   - Find tool by owner/repo and version
   - Get platform-specific entry for current platform

4. Verify binary checksum (if verify_checksums=true)
   - Calculate checksum of installed binary
   - Compare with lock file checksum
   - If mismatch:
     - strict_checksums=true: FAIL with error
     - strict_checksums=false: WARN and continue

5. Execute tool
```

### Lock File Update Triggers

Lock file is automatically updated when:

1. **Installing a tool**: `atmos toolchain install terraform@1.13.4`
2. **Setting default version**: `atmos toolchain set terraform@1.10.3`
3. **Uninstalling a tool**: `atmos toolchain uninstall terraform@1.9.8`
4. **Manual lock**: `atmos toolchain lock`

Lock file is NOT updated when:
- Running tools (read-only operations)
- Listing tools (`atmos toolchain list`)
- Querying tool info (`atmos toolchain which terraform`)

## Commands

### New Commands

```bash
# Generate/update lock file
atmos toolchain lock [flags]
  --from-versions-file    Generate from .tool-versions
  --update               Update checksums for existing entries
  --regenerate           Regenerate entire lock file
  --verify               Verify all locked tools

# Verify lock file integrity
atmos toolchain verify [flags]
  --all                  Verify all tools (default)
  --tool=<name>          Verify specific tool

# Show lock file information
atmos toolchain lock info [tool]
  # Shows locked version, checksums, platforms for tool(s)
```

### Modified Commands

```bash
# Install now updates lock file
atmos toolchain install <tool>[@version] [flags]
  --no-lock              Skip lock file update
  --update-lock          Update existing lock entry

# Uninstall now removes from lock file
atmos toolchain uninstall <tool>[@version] [flags]
  --keep-lock            Keep lock file entry
```

## Relationship Between `.tool-versions` and `toolchain.lock.yaml`

Both files serve **different, complementary purposes** and are designed to coexist:

### `.tool-versions` (ASDF Format)
**Purpose**: Simple, human-readable version tracking
- ✅ Lists tool versions in simple format: `terraform 1.13.4 1.10.3`
- ✅ ASDF compatibility for users who use ASDF tooling
- ✅ Easy to manually edit
- ✅ Quick visual reference for installed versions
- ✅ Works across different toolchain systems
- ❌ No security verification (checksums)
- ❌ No multi-platform support
- ❌ No tamper detection

### `toolchain.lock.yaml` (Atmos Native)
**Purpose**: Security, reproducibility, multi-platform support
- ✅ Cryptographic checksums for integrity verification
- ✅ Platform-specific URLs and checksums (darwin, linux, windows)
- ✅ Tamper detection and security
- ✅ Deterministic installations across teams
- ✅ Auto-generated and managed
- ❌ Not human-editable (managed by tooling)
- ❌ YAML format (more verbose)
- ❌ Atmos-specific (not cross-compatible)

### Recommended Usage (Default)

**Both enabled** - Get the benefits of both systems:

```yaml
toolchain:
  use_lock_file: true      # Security and reproducibility
  use_tool_versions: true  # Simplicity and ASDF compatibility
```

**Workflow**:
1. Run `atmos toolchain install terraform@1.13.4`
2. Updates `.tool-versions`: `terraform 1.13.4` (simple, human-readable)
3. Updates `toolchain.lock.yaml`: Full checksums, URLs, multi-platform data
4. Team members get both: Quick reference AND security verification

### Alternative Configurations

**Lock file only** (Maximum security, no ASDF):
```yaml
toolchain:
  use_lock_file: true
  use_tool_versions: false
```

**Tool versions only** (ASDF compatibility, no security):
```yaml
toolchain:
  use_lock_file: false
  use_tool_versions: true
```

## Security Considerations

### Checksum Verification

1. **Always verify checksums when available**
   - Default to SHA256 (most common)
   - Support SHA512, SHA1 (deprecated but may be needed)
   - Fail on mismatch unless `strict_checksums: false`

2. **Checksum sources priority**:
   - Registry-provided checksums (preferred)
   - Release artifact checksums (GitHub releases, etc.)
   - Calculated on first install (fallback)

3. **Checksum storage**:
   - Format: `algorithm:hash` (e.g., `sha256:abc123...`)
   - Store per-platform
   - Update on explicit lock file regeneration

### Lock File Integrity

1. **Commit lock file to version control**
   - Treat like `go.sum`, `package-lock.json`
   - Review changes in PRs

2. **Detect tampering**:
   - Validate YAML structure on load
   - Check for required fields
   - Verify checksums on tool execution

3. **Platform security**:
   - Lock includes all platforms (darwin, linux, windows)
   - Team members on different platforms use same lock file
   - Each platform verifies its own entry

## Error Handling

### Lock File Errors

```
Error: Lock file checksum mismatch for hashicorp/terraform@1.13.4
Expected: sha256:abc123...
Got:      sha256:def456...

This may indicate:
- Binary was modified after installation
- Download was corrupted
- Security issue (binary tampering)

To fix:
1. Reinstall: atmos toolchain install terraform@1.13.4 --force
2. Update lock: atmos toolchain lock --update
3. Disable strict mode: Set toolchain.strict_checksums: false (not recommended)
```

### Missing Lock File

```
Warning: Lock file not found at .tools/toolchain.lock.yaml

The lock file ensures reproducible tool installations and verifies binary integrity.

To generate:
  atmos toolchain lock

To disable:
  Set toolchain.use_lock_file: false in atmos.yaml
```

### Platform Missing

```
Error: No darwin_arm64 entry in lock file for hashicorp/terraform@1.13.4

Your platform (darwin_arm64) is not in the lock file.
This may happen if the lock file was generated on a different platform.

To fix:
1. Install tool for your platform: atmos toolchain install terraform@1.13.4
2. Update lock file: atmos toolchain lock --update
3. Commit updated lock file
```

## Examples

### Basic Usage

```bash
# Install a tool (auto-updates lock file)
$ atmos toolchain install terraform@1.13.4
✓ Resolved hashicorp/terraform@1.13.4
✓ Downloaded darwin_arm64 binary
✓ Verified checksum: sha256:abc123...
✓ Installed to .tools/bin/hashicorp/terraform/1.13.4/terraform
✓ Updated .tools/toolchain.lock.yaml
✓ Updated .tool-versions

# Verify all tools
$ atmos toolchain verify
✓ hashicorp/terraform@1.13.4 (checksum verified)
✓ opentofu/opentofu@1.10.6 (checksum verified)
✓ kubernetes/kubectl@1.34.1 (checksum verified)

# Show lock file info
$ atmos toolchain lock info terraform
Tool: hashicorp/terraform
Version: 1.13.4
Platforms: darwin_amd64, darwin_arm64, linux_amd64, windows_amd64

darwin_arm64:
  URL: https://releases.hashicorp.com/terraform/1.13.4/terraform_1.13.4_darwin_arm64.zip
  Checksum: sha256:abc123def456...
  Size: 93.1 MB
```

### CI/CD Usage

```yaml
# .github/workflows/ci.yml
name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Atmos
        run: |
          curl -sSL https://atmos.tools/install.sh | bash

      # Lock file ensures exact same tool versions as local
      - name: Verify toolchain
        run: |
          atmos toolchain verify --all

      # Tools are automatically installed with locked versions
      - name: Run terraform
        run: |
          atmos terraform plan myapp -s dev
```

### Team Collaboration

```bash
# Developer A (macOS ARM64) adds new tool
$ atmos toolchain install kubectl@1.34.1
$ git add .tools/toolchain.lock.yaml
$ git commit -m "Add kubectl to toolchain"

# Developer B (Linux AMD64) pulls changes
$ git pull
$ atmos toolchain install kubectl@1.34.1
# Installs linux_amd64 variant, verifies checksum from lock file
# Lock file already has linux_amd64 entry (added by Developer A's install)

# Developer C (Windows) pulls changes
$ git pull
$ atmos toolchain install kubectl@1.34.1
# Installs windows_amd64 variant, verifies checksum
```

## Implementation Notes

### Phase 1: Core Lock File (v1)
- [ ] Define lock file schema (YAML)
- [ ] Implement lock file read/write
- [ ] Add `toolchain.lock_file` config option
- [ ] Add `toolchain.use_lock_file` config option
- [ ] Update `install` command to write lock file
- [ ] Implement checksum calculation and verification
- [ ] Add `atmos toolchain lock` command
- [ ] Add `atmos toolchain verify` command

### Phase 2: Multi-Platform Support (v2)
- [ ] Fetch platform metadata from registries
- [ ] Store multiple platform entries per tool
- [ ] Verify platform-specific checksums
- [ ] Handle platform-missing errors gracefully

### Phase 3: Advanced Features (v3)
- [ ] Add `atmos toolchain lock info` command
- [ ] Implement `--from-versions-file` flag
- [ ] Add automatic checksum fetching from releases
- [ ] Implement lock file migration tools
- [ ] Add lock file validation on every tool run

### Phase 4: Developer Experience (v4)
- [ ] Add colorized verification output
- [ ] Improve error messages with actionable suggestions
- [ ] Add `--no-lock` flag to commands
- [ ] Implement lock file diff command
- [ ] Add lock file auto-fix command

## Testing Strategy

### Unit Tests
- Lock file parsing and validation
- Checksum calculation and verification
- Platform detection and entry selection
- Configuration option handling
- Error handling for missing/invalid entries

### Integration Tests
- Install tool and verify lock file updated
- Verify checksums on tool execution
- Multi-platform lock file handling
- Migration from .tool-versions to lock file
- Lock file regeneration

### E2E Tests
- Full workflow: install → verify → use
- Team collaboration scenario (different platforms)
- CI/CD pipeline integration
- Lock file tampering detection

## Success Metrics

1. **Adoption**: % of users enabling lock file support
2. **Security**: # of checksum mismatches detected
3. **Reproducibility**: # of "works on my machine" issues resolved
4. **Performance**: Lock file verification overhead < 50ms
5. **Compatibility**: Support for 95%+ of tools in Aqua registry

## Future Enhancements

### Cryptographic Signing (High Priority Post-V1)

**GPG/PGP Signature Support**:
- Sign lock file with GPG/PGP key to prevent tampering
- Verify signature before using lock file
- Support for team signing keys
- Integration with commit signing workflows

**Example signed lock file**:
```yaml
# toolchain.lock.yaml
version: 1
tools:
  hashicorp/terraform:
    version: 1.13.4
    # ... tool configuration

metadata:
  generated_at: "2025-10-24T14:31:00Z"
  atmos_version: "1.96.0"
  signature:
    algorithm: pgp
    key_id: 0x1234567890ABCDEF
    signature: |
      -----BEGIN PGP SIGNATURE-----
      iQIzBAABCAAdFiEE...
      -----END PGP SIGNATURE-----
```

**Verification workflow**:
```bash
# Sign lock file after generation
$ atmos toolchain lock --sign
Enter GPG passphrase:
✓ Signed toolchain.lock.yaml with key 0x1234567890ABCDEF

# Verify signature on use
$ atmos terraform plan
✓ Verified toolchain.lock.yaml signature
✓ Signature valid, signed by: team@company.com
```

**Configuration**:
```yaml
toolchain:
  lock_file: .tools/toolchain.lock.yaml
  signing:
    enabled: true
    key_id: 0x1234567890ABCDEF
    require_signature: true  # Fail if signature missing/invalid
    trusted_keys:
      - 0x1234567890ABCDEF  # Team lead
      - 0xFEDCBA0987654321  # DevOps team
```

### Other Post-V1 Enhancements
- Support for private registry checksums
- Lock file encryption for sensitive tools
- Automatic dependency resolution
- Lock file merging for monorepos
- Network-based lock file caching

### Post-V2
- Integration with Atmos Pro for centralized lock file management
- Lock file auditing and compliance reporting
- Automatic security vulnerability scanning
- Lock file diff visualization in UI
- Integration with software bill of materials (SBOM) generation

## References

- [Go Modules and go.sum](https://go.dev/ref/mod#go-sum-files)
- [Terraform Lock Files](https://developer.hashicorp.com/terraform/language/files/dependency-lock)
- [NPM package-lock.json](https://docs.npmjs.com/cli/v10/configuring-npm/package-lock-json)
- [Cargo.lock](https://doc.rust-lang.org/cargo/guide/cargo-toml-vs-cargo-lock.html)
- [ASDF .tool-versions](https://asdf-vm.com/manage/configuration.html#tool-versions)
