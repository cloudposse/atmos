## ANALYSIS COMPLETE - NOT A CODE BUG

**Status:** This is expected behavior, not a bug.

### Root Cause

The `env` template function (from Sprig) returns an empty string when the environment variable is NOT set. This is the standard behavior of `os.Getenv()` in Go.

### Why the user sees empty values

The templates like:
```yaml
role_arn: 'arn:aws:iam::{{ env "state_account_id" }}:role/...'
```

Render as `arn:aws:iam:::role/...` because the environment variables (`state_account_id`, `gbl_environment`, etc.) are not set in the shell when running atmos.

### Why `.vars` works but `env` doesn't

- `.vars.namespace` works because it comes from the stack YAML configuration passed to the template
- `env "..."` reads from OS environment variables, which are NOT set

### Why "backend.tf.json looks correct"

The backend.tf.json file is generated by `terraform generate backends` and persists on disk. If it was generated at a time when the environment variables WERE set, it will contain the correct values. But when atmos processes the stack YAML at runtime (e.g., during `terraform plan`), it re-reads and processes the templates, and at that point the env vars are not set.

### Solution

The user needs to ensure their environment variables are set before running atmos commands:

```bash
export state_account_id=123456789012
export gbl_environment=dev
export state_stage=prod
export state_role_suffix=terraform-backend
atmos terraform plan ...
```

### Code Investigation Summary

1. Reviewed all changes between v1.201.0 and v1.202.0 - no template processing changes
2. Confirmed Sprig's `env` function is correctly included in the template function map
3. Created tests that verify the behavior (see `internal/exec/template_env_function_test.go`)

---

## ORIGINAL USER REPORT BELOW

I'm having an issue in version 1.202.0 and up where now the role authentication is now being resolved correctly.
I use asume roles with SSO logging and this works perfectly on versions before that one but since this version the role is not resolving correctly even when the backend.tf.json and providers.tf.json file looks good. the only thing I see that might be the issue is that I use interpolation on the org config to generate this roles and on the terminal the role is not resolving but as mention before the files are looking good.
any suggestion or any changes on how atmos resolved interpolation that it might affect this?

I'm using terraform orgs to template the terraform roles to assume so I have in orgs/acme/_defaults.yaml the backend configuration like normal:
terraform:
backend_type: s3
backend:
s3:
encrypt: true
use_lockfile: true
bucket: '{{ .vars.namespace }}-gbl-root-tfstate'
key: 'terraform.tfstate'
region: '{{ .vars.region }}'
but for the backend role I have orgs/acme/plat/_default.yaml:
terraform:
backend_type: s3
backend:
s3:
assume_role:
role_arn: 'arn:aws:iam::{{ (env "state_account_id") }}:role/{{ .vars.namespace }}-{{ (env "gbl_environment") }}-{{ (env "state_stage") }}-{{ (env "state_role_suffix") }}'
and for the provider role I have orgs/acme/plat/dev/_default.yaml
terraform:
settings:
github:
actions_enabled: true
providers:
aws:
region: '{{ .vars.region }}'
assume_role:
role_arn: 'arn:aws:iam::{{ (printf "%s_account_id" .vars.stage | env) }}:role/{{ .vars.namespace }}-{{ (env "gbl_environment") }}-{{ .vars.stage }}-{{ (printf "%s_role_suffix" .vars.stage | env) }}'
What I think is happening is that in the latest version the evaluation on orgs has change and is not longer getting the Environment variables on the CLI context only the .vars work there now. I think this is the issue bc the error show that is trying to assume the incorrect role and it looks like this:
Assuming role ARN=arn:aws:iam:::role/acme---

-------


Invalid role ARN composed: Template env() values are empty when rendering assume_role

Describe the Bug

Summary
•  When composing Terraform backend/provider assume_role.role_arn from template environment variables, the rendered ARN drops the interpolated segments and becomes invalid.
•  Variables accessed via .vars.* resolve correctly; values fetched via env "..." render as empty strings.

Impact
•  Atmos cannot assume the target role to read state or run plans, causing early failures during template evaluation.

Where it happens • In stacks under orgs/... (e.g., stacks/orgs////_defaults.yaml) where role_arn is built like: ◦ arn:aws:iam::{{ (printf "%s_account_id" .vars.stage | env) }}:role/{{ .vars.namespace }}-{{ (env "gbl_environment") }}-{{ .vars.stage }}-{{ (printf "%s_role_suffix" .vars.stage | env) }}

Expected Behavior

The assume_role ARN is fully rendered using the template env values, and Atmos can assume the role.

Steps to Reproduce

I'm using terraform orgs to template the terraform roles to assume so I have in orgs/acme/_defaults.yaml the backend configuration like normal:

terraform:
backend_type: s3
backend:
s3:
encrypt: true
use_lockfile: true
bucket: '{{ .vars.namespace }}-gbl-root-tfstate'
key: 'terraform.tfstate'
region: '{{ .vars.region }}'

but for the backend role I have orgs/acme/plat/_default.yaml:

terraform:
backend_type: s3
backend:
s3:
assume_role:
role_arn: 'arn:aws:iam::{{ (env "state_account_id") }}:role/{{ .vars.namespace }}-{{ (env "gbl_environment") }}-{{ (env "state_stage") }}-{{ (env "state_role_suffix") }}'

and for the provider role I have orgs/acme/plat/dev/_default.yaml:

terraform:
settings:
github:
actions_enabled: true
providers:
aws:
region: '{{ .vars.region }}'
assume_role:
role_arn: 'arn:aws:iam::{{ (printf "%s_account_id" .vars.stage | env) }}:role/{{ .vars.namespace }}-{{ (env "gbl_environment") }}-{{ .vars.stage }}-{{ (printf "%s_role_suffix" .vars.stage | env) }}'

Screenshots

No response

Environment

No response

Additional Context

What I think is happening is that in the latest version the evaluation on orgs has change and is not longer getting the Environment variables on the CLI context only the .vars work there now. I think this is the issue bc the error show that is trying to assume the incorrect role and it looks like this:

Assuming role ARN=arn:aws:iam:::role/acme---

Followed by AccessDenied on sts:AssumeRole due to the invalid ARN.
