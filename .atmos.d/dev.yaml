name: dev
description: Development workflow commands for Atmos development
commands:
  - name: setup
    description: Set up local development environment
    steps:
      - |
        echo "üöÄ Setting up Atmos development environment..."

        echo "1Ô∏è‚É£  Installing Go dependencies..."
        go mod download

        echo "2Ô∏è‚É£  Installing pre-commit and golangci-lint..."
        if ! command -v pre-commit >/dev/null 2>&1; then
          if command -v brew >/dev/null 2>&1; then
            echo "Installing pre-commit via Homebrew..."
            brew install pre-commit
          elif command -v apt-get >/dev/null 2>&1; then
            echo "Installing pre-commit via apt..."
            sudo apt-get update && sudo apt-get install -y pre-commit
          else
            echo "Installing pre-commit via pip..."
            pip install --user pre-commit || pip install pre-commit
          fi
        else
          echo "pre-commit is already installed: $(pre-commit --version)"
        fi

        if ! command -v golangci-lint >/dev/null 2>&1; then
          if command -v brew >/dev/null 2>&1; then
            echo "Installing golangci-lint via Homebrew..."
            brew install golangci-lint
          else
            echo "Installing golangci-lint via curl..."
            curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin
          fi
        else
          echo "golangci-lint is already installed: $(golangci-lint --version)"
        fi

        echo "3Ô∏è‚É£  Installing pre-commit hooks..."
        pre-commit install

        echo "4Ô∏è‚É£  Installing Go tools..."
        go install mvdan.cc/gofumpt@latest

        echo "‚úÖ Development environment setup complete!"
        echo ""
        echo "Run 'atmos dev check' to check staged files (read-only)"
        echo "Run 'atmos dev check-pr' to check PR changes (read-only)"
        echo "Run 'atmos dev format' to auto-format staged files"
        echo "Run 'atmos dev format-pr' to auto-format PR changes"

  - name: check
    description: Check staged files for issues (read-only, no modifications)
    steps:
      - |
        echo "üîç Checking staged files (read-only)..."
        # Run checks without modifying files
        STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.go' | grep -v -E '^(vendor/|tests/test-cases/|tests/testdata/|tests/snapshots/)' || true)
        if [ -n "$STAGED_GO_FILES" ]; then
          echo "Checking Go formatting..."
          echo "$STAGED_GO_FILES" | xargs -I {} gofumpt -d {} 2>/dev/null | head -20 || true
          echo "Running golangci-lint..."
          golangci-lint run --new-from-rev=origin/main --config=.golangci.yml $STAGED_GO_FILES || true
        fi
        echo "üí° To auto-fix issues, run: atmos dev format"

  - name: check-pr
    description: Check PR changes for issues (read-only, no modifications)
    steps:
      - |
        echo "üîç Checking PR changes (read-only)..."
        BASE_REF="${GITHUB_BASE_REF:-main}"
        # Get changed Go files
        CHANGED_GO_FILES=$(git diff origin/$BASE_REF...HEAD --name-only -- '*.go' | grep -v -E '^(vendor/|tests/test-cases/|tests/testdata/|tests/snapshots/)' || true)
        if [ -n "$CHANGED_GO_FILES" ]; then
          echo "Checking Go formatting..."
          echo "$CHANGED_GO_FILES" | xargs -I {} gofumpt -d {} 2>/dev/null | head -20 || true
          echo "Running golangci-lint..."
          golangci-lint run --new-from-rev=origin/$BASE_REF --config=.golangci.yml || true
        fi
        echo "üí° To auto-fix issues, run: atmos dev format-pr"

  - name: check-all
    description: Check all files for issues (read-only, no modifications)
    steps:
      - |
        echo "üîç Checking all files (read-only)..."
        echo "‚ö†Ô∏è  This may take a while..."
        # Check formatting without modifying
        echo "Checking Go formatting..."
        find . -name '*.go' -not -path './vendor/*' -not -path './tests/test-cases/*' -not -path './tests/testdata/*' -not -path './tests/snapshots/*' | xargs gofumpt -d 2>/dev/null | head -50 || true
        echo "Running comprehensive linting..."
        golangci-lint run --config=.golangci.yml || true
        echo "üí° To auto-fix issues, run: atmos dev format-all (‚ö†Ô∏è  DANGEROUS)"

  - name: format
    description: Auto-format staged files
    steps:
      - |
        echo "üîß Auto-formatting staged files..."
        pre-commit run || true
        echo "‚úÖ Formatting applied to staged files"

  - name: format-pr
    description: Auto-format PR changes
    steps:
      - |
        echo "üîß Auto-formatting PR changes..."
        BASE_REF="${GITHUB_BASE_REF:-main}"
        pre-commit run --from-ref origin/$BASE_REF --to-ref HEAD || true
        echo "‚úÖ Formatting applied to PR changes"

  - name: format-all
    description: ‚ö†Ô∏è  DANGEROUS - Auto-format ALL files (excludes golden snapshots)
    steps:
      - |
        echo "‚ö†Ô∏è  WARNING: This will modify many files!"
        echo "   Excludes: vendor/, tests/test-cases/, tests/testdata/, tests/snapshots/"
        echo "   Golden snapshots and fixtures are protected."
        echo ""
        echo "   Press Ctrl+C to cancel, or wait 5 seconds to continue..."
        sleep 5
        echo "üîß Auto-formatting all files..."
        # Run pre-commit on all files with our exclude patterns
        pre-commit run --all-files || true
        echo "‚úÖ Formatting complete. Review changes with: git diff"

  - name: lint
    description: Run golangci-lint
    steps:
      - golangci-lint run --config=.golangci.yml

  - name: test
    description: Run tests
    steps:
      - go test ./... -v

  - name: build
    description: Build the Atmos binary
    steps:
      - make build

  - name: quick
    description: Quick build and test
    steps:
      - |
        echo "üèÉ Running quick build and test..."
        make build
        ./build/atmos version
        echo "‚úÖ Quick build successful!"

  - name: update-hooks
    description: Update pre-commit hooks to latest versions
    steps:
      - pre-commit autoupdate

  - name: help
    description: Show available dev commands
    steps:
      - |
        echo "Available Atmos dev commands:"
        echo ""
        echo "  atmos dev setup       - Set up local development environment"
        echo ""
        echo "  Checking (read-only, no modifications):"
        echo "  atmos dev check       - Check staged files for issues"
        echo "  atmos dev check-pr    - Check PR changes for issues"
        echo "  atmos dev check-all   - Check all files for issues"
        echo ""
        echo "  Formatting (modifies files):"
        echo "  atmos dev format      - Auto-format staged files"
        echo "  atmos dev format-pr   - Auto-format PR changes"
        echo "  atmos dev format-all  - ‚ö†Ô∏è  DANGEROUS: Auto-format ALL files"
        echo ""
        echo "  atmos dev lint        - Run golangci-lint"
        echo "  atmos dev test        - Run tests"
        echo "  atmos dev build       - Build the Atmos binary"
        echo "  atmos dev quick       - Quick build and test"
        echo "  atmos dev update-hooks - Update pre-commit hooks to latest versions"
        echo ""
        echo "Pre-commit hooks include:"
        echo "  - go-fumpt: Go code formatting"
        echo "  - go-build-mod: Verify Go compilation"
        echo "  - go-mod-tidy: Ensure go.mod is tidy"
        echo "  - golangci-lint: Comprehensive Go linting"
        echo "  - trailing-whitespace: Remove trailing whitespace"
        echo "  - end-of-file-fixer: Ensure files end with newline"
        echo "  - check-yaml: Validate YAML files"
        echo "  - check-added-large-files: Prevent large files"
